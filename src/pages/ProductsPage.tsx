
// ... imports
import { parseCSV, exportToCSV } from '@/lib/csvHelper'; // Consolodated imports

// ... existing imports
import { useState, useEffect, useCallback, useRef } from 'react';
// ... other imports

// ... remove the nested import around line 296

import { useProductStore } from '@/stores/productStore';
import { useCategoryStore, NO_BARCODE_CATEGORY_ID } from '@/stores/categoryStore';
import { canDeleteProduct, getDeleteErrorMessage } from '@/stores/authStore';
import { useCameraScanner } from '@/hooks/useBarcodeScanner';
import { formatVND } from '@/lib/cashReconciliation';
import { cn } from '@/lib/utils';
import type { CSVFormat } from '@/lib/csvImportExport';
import { importProductsFromCSV, exportProductsToCSV, downloadCSV, readFileAsText } from '@/lib/csvImportExport';
import type { Product } from '@/types';
import { generateId } from '@/lib/utils';
import { ProductDetailsModal } from '@/components/products/ProductDetailsModal';
import { ComboProductForm } from '@/components/products/ComboProductForm';
import { ImageUploader } from '@/components/products/ProductLink';
import { MultiCategorySelect } from '@/components/common/MultiCategorySelect';
import { SelectWithCRUD } from '@/components/common/SelectWithCRUD';
import { Pagination } from '@/components/common/Pagination';
import { checkBarcodeExists } from '@/components/common/BarcodeSelectionModal';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { UnitSuggestDropdown } from '@/components/common/UnitSuggestDropdown';

export function ProductsPage() {
    const { products, isLoading, loadProducts, addProduct, updateProduct, deleteProduct } = useProductStore();
    const { categories, brands, productTypes, addCategory, addBrand, addProductType: addProductTypeToStore, deleteItem } = useCategoryStore();
    const [searchQuery, setSearchQuery] = useState('');
    const [showForm, setShowForm] = useState(false);
    const [editingProduct, setEditingProduct] = useState<Product | null>(null);
    const [viewingProduct, setViewingProduct] = useState<Product | null>(null);
    const [filter, setFilter] = useState<'all' | 'low-stock' | 'inactive'>('all');
    const [showImport, setShowImport] = useState(false);
    const [importFormat, setImportFormat] = useState<CSVFormat>('auto');
    const [importPreview, setImportPreview] = useState<Partial<Product>[]>([]);
    const [productImage, setProductImage] = useState<string>('');
    const [units, setUnits] = useState<any[]>([]);
    const fileInputRef = useRef<HTMLInputElement>(null);
    const [autoGeneratedSKU, setAutoGeneratedSKU] = useState<string>('');
    const [baseUnit, setBaseUnit] = useState<string>('c√°i');

    // State for category/brand/productType selections
    const [selectedCategories, setSelectedCategories] = useState<string[]>([]);
    const [selectedBrand, setSelectedBrand] = useState<string>('');
    const [selectedProductType, setSelectedProductType] = useState<string>('');

    // Enhanced filter states
    const [productKindTab, setProductKindTab] = useState<'all' | 'normal' | 'combo' | 'unit_conversion'>('all');
    const [filterCategories, setFilterCategories] = useState<string[]>([]);
    const [filterBrands, setFilterBrands] = useState<string[]>([]);
    const [filterDateRange, setFilterDateRange] = useState<{ start: string; end: string } | null>(null);
    const [sortBy, setSortBy] = useState<'name' | 'best_selling' | 'least_selling' | 'stock_low_high' | 'stock_high_low' | 'created_at'>('name');
    const [notSoldDays, setNotSoldDays] = useState<number | null>(null); // 7, 15, 30, or custom
    const [showCategoryFilter, setShowCategoryFilter] = useState(false);
    const [showBrandFilter, setShowBrandFilter] = useState(false);
    const [showDateFilter, setShowDateFilter] = useState(false);
    const [showSortFilter, setShowSortFilter] = useState(false);
    const [showAddDropdown, setShowAddDropdown] = useState(false);
    const [newProductKind, setNewProductKind] = useState<'normal' | 'combo' | 'unit_conversion'>('normal');
    const [comboItems, setComboItems] = useState<Array<{ product_id: string; product_name: string; quantity: number }>>([]);
    const [showComboForm, setShowComboForm] = useState(false);
    // Product attributes state
    const [attributes, setAttributes] = useState<Array<{ name: string; value: string }>>([]);
    // Product variants state (with unit conversion support)
    const [variants, setVariants] = useState<Array<{
        id: string;
        name: string;
        sku: string;
        barcode: string;
        selling_price: number;
        conversion_rate: number;
        image_url: string;
        units?: Array<{ id: string; name: string; sku: string; barcode: string; conversion_rate: number; selling_price: number; image_url?: string }>;
    }>>([]);
    // Image zoom modal state  
    const [showImageZoom, setShowImageZoom] = useState<string | null>(null);

    // Collapsible section states
    const [showDescription, setShowDescription] = useState(false);
    const [showUnitsSection, setShowUnitsSection] = useState(false);
    const [showAttributesSection, setShowAttributesSection] = useState(false);
    const [showVariantsSection, setShowVariantsSection] = useState(false);

    // Selection state
    const [selectedProducts, setSelectedProducts] = useState<Set<string>>(new Set());
    const [showBulkActions, setShowBulkActions] = useState(false);

    // Refs for click outside
    const categoryFilterRef = useRef<HTMLDivElement>(null);
    const dateFilterRef = useRef<HTMLDivElement>(null);
    const brandFilterRef = useRef<HTMLDivElement>(null);
    const sortFilterRef = useRef<HTMLDivElement>(null);
    const addProductDropdownRef = useRef<HTMLDivElement>(null);

    // Click outside handler
    useEffect(() => {
        function handleClickOutside(event: MouseEvent) {
            if (categoryFilterRef.current && !categoryFilterRef.current.contains(event.target as Node)) {
                setShowCategoryFilter(false);
            }
            if (dateFilterRef.current && !dateFilterRef.current.contains(event.target as Node)) {
                setShowDateFilter(false);
            }
            if (brandFilterRef.current && !brandFilterRef.current.contains(event.target as Node)) {
                setShowBrandFilter(false);
            }
            if (sortFilterRef.current && !sortFilterRef.current.contains(event.target as Node)) {
                setShowSortFilter(false);
            }
            if (addProductDropdownRef.current && !addProductDropdownRef.current.contains(event.target as Node)) {
                setShowAddDropdown(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, []);

    // Pagination state
    const [currentPage, setCurrentPage] = useState(1);
    const [pageSize, setPageSize] = useState(20);

    useEffect(() => {
        loadProducts();
    }, [loadProducts]);

    // Helper: Generate unique SKU (PVN0001 format) across all products, variants, and units
    const generateUniqueSKU = (existingSkusOverride?: string[]): string => {
        // Collect ALL existing SKUs from products, variants, and units
        const allSKUs: string[] = existingSkusOverride || [];
        if (!existingSkusOverride) {
            products.forEach(p => {
                if (p.sku) allSKUs.push(p.sku);
                // Check variants
                if (p.variants) {
                    p.variants.forEach((v: any) => {
                        if (v.sku) allSKUs.push(v.sku);
                    });
                }
                // Check units
                if (p.units) {
                    p.units.forEach((u: any) => {
                        if (u.sku) allSKUs.push(u.sku);
                    });
                }
            });
            // Also check current form state
            variants.forEach(v => {
                if (v.sku) allSKUs.push(v.sku);
            });
            units.forEach(u => {
                if (u.sku) allSKUs.push(u.sku);
            });
        }

        let num = 1;
        let newSKU = `PVN${String(num).padStart(4, '0')}`;
        while (allSKUs.includes(newSKU)) {
            num++;
            newSKU = `PVN${String(num).padStart(4, '0')}`;
        }
        return newSKU;
    };

    // Helper: Open camera to scan barcode/SKU
    const openBarcodeScanner = (onScan: (code: string) => void, title: string = 'm√£ v·∫°ch') => {
        if (!navigator.mediaDevices) {
            alert('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ camera');
            return;
        }
        const modal = document.createElement('div');
        modal.id = 'barcode-scanner-modal';
        modal.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;';
        modal.innerHTML = `
            <div style="width:100%;max-width:360px;text-align:center;">
                <p style="color:white;font-size:16px;margin-bottom:12px;">Qu√©t ${title}</p>
                <video id="scanner-video" style="width:100%;border-radius:12px;background:#000;" autoplay playsinline></video>
                <p id="scanner-status" style="color:white;margin:12px 0;font-size:14px;">ƒêang m·ªü camera...</p>
                <button id="close-scanner" style="padding:12px 32px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;">‚úï ƒê√≥ng</button>
            </div>
        `;
        document.body.appendChild(modal);
        const video = document.getElementById('scanner-video') as HTMLVideoElement;
        const statusEl = document.getElementById('scanner-status') as HTMLElement;
        const closeBtn = document.getElementById('close-scanner') as HTMLButtonElement;
        let stream: MediaStream | null = null;
        const cleanup = () => { if (stream) stream.getTracks().forEach(t => t.stop()); modal.remove(); };
        closeBtn.onclick = cleanup;
        modal.onclick = (e) => { if (e.target === modal) cleanup(); };
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(async (s) => {
                stream = s;
                video.srcObject = stream;
                statusEl.textContent = `H∆∞·ªõng camera v√†o ${title}...`;
                if ('BarcodeDetector' in window) {
                    const detector = new (window as any).BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39', 'qr_code'] });
                    const detect = async () => {
                        if (!video.srcObject) return;
                        try {
                            const barcodes = await detector.detect(video);
                            if (barcodes.length > 0) {
                                onScan(barcodes[0].rawValue);
                                statusEl.innerHTML = '<span style="color:#22c55e;">‚úÖ ' + barcodes[0].rawValue + '</span>';
                                setTimeout(cleanup, 800);
                                return;
                            }
                        } catch (e) { }
                        requestAnimationFrame(detect);
                    };
                    detect();
                } else {
                    statusEl.innerHTML = '<span style="color:#fbbf24;">‚ö†Ô∏è Tr√¨nh duy·ªát ch∆∞a h·ªó tr·ª£ qu√©t t·ª± ƒë·ªông. Nh·∫≠p th·ªß c√¥ng:</span>';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = 'Nh·∫≠p m√£...';
                    input.style.cssText = 'width:100%;padding:12px;margin-top:8px;border-radius:8px;border:none;font-size:16px;';
                    input.onkeydown = (e) => {
                        if (e.key === 'Enter' && input.value) {
                            onScan(input.value);
                            cleanup();
                        }
                    };
                    statusEl.appendChild(input);
                    input.focus();
                }
            })
            .catch(() => { statusEl.innerHTML = '<span style="color:#ef4444;">‚ùå Kh√¥ng th·ªÉ m·ªü camera</span>'; });
    };

    // Enhanced filtering and sorting
    const filteredProducts = products.filter((p) => {
        // Search filter
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            if (!p.name.toLowerCase().includes(query) &&
                !p.sku?.toLowerCase().includes(query) &&
                !p.barcode?.includes(searchQuery)) {
                return false;
            }
        }
        // Product kind tab
        if (productKindTab !== 'all') {
            const kind = p.product_kind || 'normal';
            if (kind !== productKindTab) return false;
        }
        // Category filter
        if (filterCategories.length > 0) {
            const pCategories = p.category_ids || (p.category_id ? [p.category_id] : []);
            if (!filterCategories.some(c => pCategories.includes(c))) return false;
        }
        // Brand filter
        if (filterBrands.length > 0) {
            if (!p.brand_id || !filterBrands.includes(p.brand_id)) return false;
        }
        // Date range filter
        if (filterDateRange) {
            const created = new Date(p.created_at);
            const start = new Date(filterDateRange.start);
            const end = new Date(filterDateRange.end);
            end.setHours(23, 59, 59);
            if (created < start || created > end) return false;
        }
        // Not sold filter
        if (notSoldDays) {
            if (notSoldDays === -1) {
                // Never sold
                if (p.last_sold_at) return false;
            } else {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - notSoldDays);
                if (p.last_sold_at && new Date(p.last_sold_at) > cutoff) return false;
            }
        }
        // Stock filter
        if (filter === 'low-stock') return p.current_stock <= p.min_stock;
        return true;
    }).sort((a, b) => {
        switch (sortBy) {
            case 'best_selling': return (b.total_sold || 0) - (a.total_sold || 0);
            case 'least_selling': return (a.total_sold || 0) - (b.total_sold || 0);
            case 'stock_low_high': return a.current_stock - b.current_stock;
            case 'stock_high_low': return b.current_stock - a.current_stock;
            case 'created_at': return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
            default: return a.name.localeCompare(b.name);
        }
    });

    // Paginated products
    const paginatedProducts = filteredProducts.slice(
        (currentPage - 1) * pageSize,
        currentPage * pageSize
    );

    const handleEdit = (product: Product) => {
        setViewingProduct(null); // Close details if open
        setEditingProduct(product);
        setProductImage(product.image_url || '');
        setUnits(product.units || []);
        setSelectedCategories(product.category_ids || []);
        setSelectedBrand(product.brand_id || '');
        setSelectedProductType(product.product_type_id || '');
        setBaseUnit(product.base_unit || 'c√°i');
        setShowForm(true);
    };

    const handleAdd = () => {
        setEditingProduct(null);
        setProductImage('');
        setUnits([]);
        // Auto-select "Kh√¥ng m√£" category for new products (no barcode by default)
        setSelectedCategories([NO_BARCODE_CATEGORY_ID]);
        setSelectedBrand('');
        setSelectedProductType('');
        setBaseUnit('c√°i');

        // Auto-generate SKU using helper
        setAutoGeneratedSKU(generateUniqueSKU());

        setShowForm(true);
    };

    const handleDelete = async (product: Product, e?: React.MouseEvent) => {
        if (e) e.stopPropagation();

        // Check permission
        if (!canDeleteProduct(product)) {
            const errorMsg = getDeleteErrorMessage(product);
            alert(errorMsg || 'B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a s·∫£n ph·∫©m n√†y');
            return;
        }

        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a "${product.name}"?`)) {
            try { await deleteProduct(product.id); } catch (err) { alert('Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m'); }
        }
    };

    const handleSave = async (data: Partial<Product>) => {
        try {
            // Validation for unit_conversion products - must have at least 1 unit
            if (data.product_kind === 'unit_conversion' && units.length === 0) {
                alert('S·∫£n ph·∫©m ƒë∆°n v·ªã quy ƒë·ªïi ph·∫£i c√≥ √≠t nh·∫•t 1 ƒë∆°n v·ªã quy ƒë·ªïi!');
                return;
            }

            // Check main product barcode for duplicates
            if (data.barcode) {
                const barcodeCheck = checkBarcodeExists(products, data.barcode, editingProduct?.id);
                if (barcodeCheck.exists) {
                    const existingName = barcodeCheck.existingProduct?.name || '';
                    const unitInfo = barcodeCheck.existingUnit ? ` (ƒë∆°n v·ªã: ${barcodeCheck.existingUnit.unit_name})` : '';
                    if (!confirm(`M√£ v·∫°ch "${data.barcode}" ƒë√£ t·ªìn t·∫°i trong s·∫£n ph·∫©m "${existingName}"${unitInfo}.\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c l∆∞u kh√¥ng?`)) {
                        return;
                    }
                }
            }

            // Check unit barcodes for duplicates
            for (const unit of units) {
                if (unit.barcode) {
                    const unitBarcodeCheck = checkBarcodeExists(products, unit.barcode, editingProduct?.id);
                    if (unitBarcodeCheck.exists) {
                        const existingName = unitBarcodeCheck.existingProduct?.name || '';
                        const unitInfo = unitBarcodeCheck.existingUnit ? ` (ƒë∆°n v·ªã: ${unitBarcodeCheck.existingUnit.unit_name})` : '';
                        if (!confirm(`M√£ v·∫°ch ƒë∆°n v·ªã "${unit.barcode}" (ƒë∆°n v·ªã ${unit.unit_name}) ƒë√£ t·ªìn t·∫°i trong s·∫£n ph·∫©m "${existingName}"${unitInfo}.\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c l∆∞u kh√¥ng?`)) {
                            return;
                        }
                    }
                }
            }

            // ===== KH√îNG M√É CATEGORY LOGIC =====
            // Import the constant and function
            const { NO_BARCODE_CATEGORY_ID, useCategoryStore: getCategoryStore } = await import('@/stores/categoryStore');
            const categoryStore = getCategoryStore.getState();

            // Determine final category_ids with Kh√¥ng m√£ logic
            let finalCategoryIds = [...selectedCategories];
            // Barcode is considered "real" only if it's not empty AND different from SKU
            // If barcode equals SKU (auto-generated), treat as no barcode
            const sku = data.sku || '';
            const barcode = data.barcode || '';
            const hasRealBarcode = barcode.trim() !== '' && barcode !== sku;
            const hadBarcodeBeforeEdit = Boolean(editingProduct?.barcode && editingProduct.barcode !== editingProduct.sku);

            if (!hasRealBarcode) {
                // Product has no barcode - add to "Kh√¥ng m√£" category
                const noBarcodeCategory = categoryStore.getOrCreateNoBarcodeCategory();
                if (!finalCategoryIds.includes(noBarcodeCategory.id)) {
                    finalCategoryIds.push(noBarcodeCategory.id);
                }
            } else if (hasRealBarcode && !hadBarcodeBeforeEdit) {
                // Product now has barcode but didn't before - remove from "Kh√¥ng m√£"
                finalCategoryIds = finalCategoryIds.filter(id => id !== NO_BARCODE_CATEGORY_ID);
            } else if (hasRealBarcode) {
                // Product has barcode - ensure not in "Kh√¥ng m√£" 
                finalCategoryIds = finalCategoryIds.filter(id => id !== NO_BARCODE_CATEGORY_ID);
            }
            // ===== END KH√îNG M√É LOGIC =====

            // Include productImage, units, and category selections in data
            const saveData = {
                ...data,
                image_url: productImage || undefined,
                units: units,
                category_ids: finalCategoryIds,
                brand_id: selectedBrand || undefined,
                product_type_id: selectedProductType || undefined,
                // Include variants and attributes
                variants: variants.length > 0 ? variants : undefined,
                attributes: attributes.length > 0 ? attributes : undefined
            };
            if (editingProduct) await updateProduct(editingProduct.id, saveData);
            else await addProduct(saveData as Omit<Product, 'id' | 'created_at' | 'updated_at'>);
            setShowForm(false);
            setEditingProduct(null);
            setProductImage('');
            setUnits([]);
            setSelectedCategories([]);
            setSelectedBrand('');
            setSelectedProductType('');
            setVariants([]);
            setAttributes([]);
        } catch (err) { alert('Kh√¥ng th·ªÉ l∆∞u s·∫£n ph·∫©m'); }
    };

    const handleAddUnit = () => {
        setUnits([...units, {
            id: generateId(),
            unit_name: '',
            conversion_rate: 1,
            selling_price: 0,
            barcode: '',
            is_base_unit: false
        }]);
    };

    const handleUpdateUnit = (index: number, field: string, value: any) => {
        const newUnits = [...units];
        newUnits[index] = { ...newUnits[index], [field]: value };
        setUnits(newUnits);
    };

    const handleRemoveUnit = (index: number) => {
        const newUnits = [...units];
        newUnits.splice(index, 1);
        setUnits(newUnits);
    };

    const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;
        try {
            const rawData = await parseCSV(file);
            setImportPreview(rawData.map((row: any) => ({
                name: row['T√™n s·∫£n ph·∫©m'] || row['T√™n h√†ng'] || '',
                sku: row['M√£ SKU'] || row['M√£ h√†ng'] || '',
                current_stock: parseInt(row['T·ªìn kho'] || '0'),
                cost_price: parseInt(row['Gi√° v·ªën'] || '0'),
                selling_price: parseInt(row['Gi√° b√°n'] || '0'),
                base_unit: row['ƒê∆°n v·ªã'] || row['DVT c∆° b·∫£n'] || 'c√°i',
                barcode: row['Barcode'] || ''
            })));
            setShowImport(true);
        } catch (err) { alert('L·ªói ƒë·ªçc file CSV'); }
    };

    const handleImportConfirm = async () => {
        for (const p of importPreview) await addProduct(p as Omit<Product, 'id' | 'created_at' | 'updated_at'>);
        setShowImport(false);
        setImportPreview([]);
        alert(`ƒê√£ nh·∫≠p ${importPreview.length} s·∫£n ph·∫©m`);
    };

    const handleExport = (format: CSVFormat) => {
        let columns: { key: string; header: string; formatter?: (val: any) => string }[] = [];

        if (format === 'sapo') {
            columns = [
                { key: 'sku', header: 'M√£ SKU' },
                { key: 'name', header: 'T√™n s·∫£n ph·∫©m' },
                { key: 'category_id', header: 'Danh m·ª•c', formatter: (id) => categories.find(c => c.id === id)?.name || '' },
                { key: 'brand_id', header: 'Nh√£n hi·ªáu', formatter: (id) => brands.find(b => b.id === id)?.name || '' },
                { key: 'base_unit', header: 'ƒê∆°n v·ªã' },
                { key: 'cost_price', header: 'Gi√° v·ªën', formatter: (val) => val?.toString() || '0' },
                { key: 'selling_price', header: 'Gi√° b√°n', formatter: (val) => val?.toString() || '0' },
                { key: 'current_stock', header: 'T·ªìn kho', formatter: (val) => val?.toString() || '0' },
                { key: 'min_stock', header: 'ƒê·ªãnh m·ª©c t·ªìn kho', formatter: (val) => val?.toString() || '0' },
                { key: 'max_stock', header: 'T·ªìn kho t·ªëi ƒëa', formatter: (val) => val?.toString() || '0' },
                { key: 'barcode', header: 'Barcode' },
                { key: 'description', header: 'M√¥ t·∫£' }
            ];
        } else {
            // KiotViet format (simplified)
            columns = [
                { key: 'name', header: 'T√™n h√†ng' },
                { key: 'sku', header: 'M√£ h√†ng' },
                { key: 'category_id', header: 'Nh√≥m h√†ng', formatter: (id) => categories.find(c => c.id === id)?.name || '' },
                { key: 'cost_price', header: 'Gi√° v·ªën', formatter: (val) => val?.toString() || '0' },
                { key: 'selling_price', header: 'Gi√° b√°n', formatter: (val) => val?.toString() || '0' },
                { key: 'current_stock', header: 'T·ªìn kho', formatter: (val) => val?.toString() || '0' },
                { key: 'base_unit', header: 'DVT c∆° b·∫£n' }
            ];
        }

        const filename = `products_export_${format}_${new Date().toISOString().split('T')[0]}`;
        exportToCSV(products, columns, filename);
    };

    const lowStockCount = products.filter((p) => p.current_stock <= p.min_stock).length;

    return (
        <>
            {/* Combo Product Form */}
            {showComboForm && (
                <ComboProductForm
                    editingProduct={editingProduct}
                    onSave={async (data) => {
                        if (editingProduct) {
                            await updateProduct(editingProduct.id, data);
                        } else {
                            await addProduct(data as any);
                        }
                        setShowComboForm(false);
                        setEditingProduct(null);
                    }}
                    onCancel={() => {
                        setShowComboForm(false);
                        setEditingProduct(null);
                    }}
                />
            )}

            {!showComboForm && (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-200">
                        <div className="container-app py-4">
                            {/* Title and Action Buttons */}
                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div>
                                    <h1 className="text-xl font-bold text-gray-900">Danh s√°ch s·∫£n ph·∫©m</h1>
                                </div>
                                <div className="flex items-center gap-2">
                                    <input ref={fileInputRef} type="file" accept=".csv" onChange={handleFileSelect} className="hidden" />
                                    <button onClick={() => fileInputRef.current?.click()} className="px-3 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50">üì• Nh·∫≠p file</button>
                                    <div className="relative group">
                                        <button className="px-3 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50">üì§ Xu·∫•t file ‚ñæ</button>
                                        <div className="absolute right-0 mt-1 w-48 bg-white border rounded-lg shadow-lg hidden group-hover:block z-10">
                                            <button onClick={() => handleExport('sapo')} className="block w-full text-left px-4 py-2 hover:bg-gray-50">ƒê·ªãnh d·∫°ng Sapo</button>
                                            <button onClick={() => handleExport('kiotviet')} className="block w-full text-left px-4 py-2 hover:bg-gray-50">M·∫´u KiotViet</button>
                                        </div>
                                    </div>
                                    {/* Add Product Split Button */}
                                    <div className="relative flex">
                                        {/* Main button - adds normal product directly */}
                                        <button
                                            onClick={() => { setNewProductKind('normal'); handleAdd(); }}
                                            className="px-4 py-2 bg-blue-500 text-white rounded-l-lg font-medium hover:bg-blue-600"
                                        >
                                            + Th√™m s·∫£n ph·∫©m
                                        </button>
                                        {/* Arrow button - shows dropdown */}
                                        <button
                                            onClick={() => setShowAddDropdown(!showAddDropdown)}
                                            className="px-2 py-2 bg-blue-500 text-white rounded-r-lg border-l border-blue-400 hover:bg-blue-600"
                                        >
                                            ‚ñæ
                                        </button>
                                        {showAddDropdown && (
                                            <div className="absolute right-0 top-full mt-1 w-56 bg-white border rounded-lg shadow-lg z-20">
                                                <button onClick={() => { setNewProductKind('normal'); handleAdd(); setShowAddDropdown(false); }} className="block w-full text-left px-4 py-3 hover:bg-blue-50 border-b">
                                                    üì¶ Th√™m s·∫£n ph·∫©m th∆∞·ªùng
                                                </button>
                                                <button onClick={() => { setNewProductKind('combo'); setShowComboForm(true); setShowAddDropdown(false); }} className="block w-full text-left px-4 py-3 hover:bg-blue-50 border-b">
                                                    üéÅ Th√™m s·∫£n ph·∫©m combo
                                                </button>
                                                <button onClick={() => { setNewProductKind('unit_conversion'); handleAdd(); setShowAddDropdown(false); }} className="block w-full text-left px-4 py-3 hover:bg-blue-50">
                                                    üîÑ Th√™m s·∫£n ph·∫©m c√≥ ƒë∆°n v·ªã quy ƒë·ªïi
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Product Kind Tabs */}
                            <div className="mt-4 flex items-center gap-1 border-b">
                                <button onClick={() => setProductKindTab('all')} className={cn("px-4 py-2.5 text-sm font-medium border-b-2 transition-colors", productKindTab === 'all' ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700")}>
                                    T·∫•t c·∫£ s·∫£n ph·∫©m
                                </button>
                                <button onClick={() => setProductKindTab('combo')} className={cn("px-4 py-2.5 text-sm font-medium border-b-2 transition-colors", productKindTab === 'combo' ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700")}>
                                    Combo
                                </button>
                                <button onClick={() => setProductKindTab('unit_conversion')} className={cn("px-4 py-2.5 text-sm font-medium border-b-2 transition-colors", productKindTab === 'unit_conversion' ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700")}>
                                    S·∫£n ph·∫©m quy ƒë·ªïi
                                </button>
                            </div>

                            {/* Search and Filters Row */}
                            <div className="mt-4 flex flex-wrap items-center gap-3">
                                {/* Search */}
                                <div className="relative flex-1 min-w-[250px]">
                                    <input
                                        type="text"
                                        placeholder="T√¨m ki·∫øm theo m√£ s·∫£n ph·∫©m, t√™n s·∫£n ph·∫©m, barcode"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <span className="absolute left-3 top-2.5 text-gray-400">üîç</span>
                                </div>

                                {/* Category Filter Dropdown */}
                                <div className="relative" ref={categoryFilterRef}>
                                    <button
                                        onClick={() => { setShowCategoryFilter(!showCategoryFilter); setShowBrandFilter(false); setShowDateFilter(false); setShowSortFilter(false); }}
                                        className={cn("px-4 py-2 rounded-lg border text-sm flex items-center gap-2", filterCategories.length > 0 ? "bg-blue-50 border-blue-300 text-blue-700" : "bg-white")}
                                    >
                                        Lo·∫°i s·∫£n ph·∫©m {filterCategories.length > 0 && `(${filterCategories.length})`} ‚ñæ
                                    </button>
                                    {showCategoryFilter && (
                                        <div className="absolute left-0 mt-1 w-64 bg-white border rounded-lg shadow-lg z-20 p-3">
                                            <input type="text" placeholder="T√¨m ki·∫øm" className="w-full px-3 py-2 border rounded-lg mb-2 text-sm" />
                                            <div className="max-h-48 overflow-y-auto space-y-1">
                                                {categories.map(cat => (
                                                    <label key={cat.id} className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={filterCategories.includes(cat.id)}
                                                            onChange={(e) => {
                                                                if (e.target.checked) setFilterCategories([...filterCategories, cat.id]);
                                                                else setFilterCategories(filterCategories.filter(c => c !== cat.id));
                                                            }}
                                                            className="w-4 h-4 text-blue-500"
                                                        />
                                                        <span className="text-sm">{cat.name}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            <button onClick={() => setShowCategoryFilter(false)} className="w-full mt-2 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium">L·ªçc</button>
                                        </div>
                                    )}
                                </div>

                                {/* Date Filter Dropdown */}
                                <div className="relative" ref={dateFilterRef}>
                                    <button
                                        onClick={() => { setShowDateFilter(!showDateFilter); setShowCategoryFilter(false); setShowBrandFilter(false); setShowSortFilter(false); }}
                                        className={cn("px-4 py-2 rounded-lg border text-sm flex items-center gap-2", filterDateRange ? "bg-blue-50 border-blue-300 text-blue-700" : "bg-white")}
                                    >
                                        Ng√†y t·∫°o ‚ñæ
                                    </button>
                                    {showDateFilter && (
                                        <div className="absolute left-0 mt-1 w-64 bg-white border rounded-lg shadow-lg z-20 p-3">
                                            <div className="grid grid-cols-2 gap-2 mb-3">
                                                {[
                                                    { label: 'H√¥m nay', days: 0 },
                                                    { label: 'H√¥m qua', days: 1 },
                                                    { label: 'Tu·∫ßn tr∆∞·ªõc', days: 14 },
                                                    { label: 'Tu·∫ßn n√†y', days: 7 },
                                                    { label: 'Th√°ng tr∆∞·ªõc', days: 60 },
                                                    { label: 'Th√°ng n√†y', days: 30 },
                                                ].map(opt => (
                                                    <button
                                                        key={opt.label}
                                                        onClick={() => {
                                                            const end = new Date();
                                                            const start = new Date();
                                                            start.setDate(start.getDate() - opt.days);
                                                            setFilterDateRange({ start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] });
                                                        }}
                                                        className="px-3 py-2 border rounded-lg text-sm hover:bg-gray-50"
                                                    >
                                                        {opt.label}
                                                    </button>
                                                ))}
                                            </div>
                                            <button onClick={() => { setFilterDateRange(null); setShowDateFilter(false); }} className="w-full py-2 border rounded-lg text-sm mb-2">T√πy ch·ªçn</button>
                                            <button onClick={() => setShowDateFilter(false)} className="w-full py-2 bg-blue-500 text-white rounded-lg text-sm font-medium">L·ªçc</button>
                                        </div>
                                    )}
                                </div>

                                {/* Brand Filter Dropdown */}
                                <div className="relative" ref={brandFilterRef}>
                                    <button
                                        onClick={() => { setShowBrandFilter(!showBrandFilter); setShowCategoryFilter(false); setShowDateFilter(false); setShowSortFilter(false); }}
                                        className={cn("px-4 py-2 rounded-lg border text-sm flex items-center gap-2", filterBrands.length > 0 ? "bg-blue-50 border-blue-300 text-blue-700" : "bg-white")}
                                    >
                                        Nh√£n hi·ªáu {filterBrands.length > 0 && `(${filterBrands.length})`} ‚ñæ
                                    </button>
                                    {showBrandFilter && (
                                        <div className="absolute left-0 mt-1 w-64 bg-white border rounded-lg shadow-lg z-20 p-3">
                                            <input type="text" placeholder="T√¨m ki·∫øm" className="w-full px-3 py-2 border rounded-lg mb-2 text-sm" />
                                            <div className="max-h-48 overflow-y-auto space-y-1">
                                                {brands.map(brand => (
                                                    <label key={brand.id} className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={filterBrands.includes(brand.id)}
                                                            onChange={(e) => {
                                                                if (e.target.checked) setFilterBrands([...filterBrands, brand.id]);
                                                                else setFilterBrands(filterBrands.filter(b => b !== brand.id));
                                                            }}
                                                            className="w-4 h-4 text-blue-500"
                                                        />
                                                        <span className="text-sm">{brand.name}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            <button onClick={() => setShowBrandFilter(false)} className="w-full mt-2 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium">L·ªçc</button>
                                        </div>
                                    )}
                                </div>

                                {/* Sort/Other Filter Dropdown */}
                                <div className="relative" ref={sortFilterRef}>
                                    <button
                                        onClick={() => { setShowSortFilter(!showSortFilter); setShowCategoryFilter(false); setShowBrandFilter(false); setShowDateFilter(false); }}
                                        className={cn("px-4 py-2 rounded-lg border text-sm flex items-center gap-2", (sortBy || notSoldDays) ? "bg-blue-50 border-blue-300 text-blue-700" : "bg-white")}
                                    >
                                        üîß B·ªô l·ªçc kh√°c ‚ñæ
                                    </button>
                                    {showSortFilter && (
                                        <div className="absolute right-0 mt-1 w-72 bg-white border rounded-lg shadow-lg z-20 p-3">
                                            <p className="text-xs text-gray-500 mb-2 font-medium">S·∫ÆP X·∫æP THEO</p>
                                            <div className="space-y-1 mb-3">
                                                {[
                                                    { value: 'best_selling', label: 'B√°n ch·∫°y nh·∫•t' },
                                                    { value: 'least_selling', label: 'B√°n √≠t nh·∫•t' },
                                                    { value: 'stock_low_high', label: 'T·ªìn kho: Th·∫•p ‚Üí Cao' },
                                                    { value: 'stock_high_low', label: 'T·ªìn kho: Cao ‚Üí Th·∫•p' },
                                                    { value: 'created_at', label: 'Ng√†y t·∫°o m·ªõi nh·∫•t' },
                                                ].map(opt => (
                                                    <label key={opt.value} className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                                        <input type="radio" name="sortBy" checked={sortBy === opt.value} onChange={() => setSortBy(opt.value as any)} className="w-4 h-4" />
                                                        <span className="text-sm">{opt.label}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            <div className="border-t border-gray-100 my-2"></div>
                                            <p className="text-xs text-gray-500 mb-2 font-medium mt-3">S·∫¢N PH·∫®M CH∆ØA B√ÅN</p>
                                            <div className="grid grid-cols-4 gap-2 mb-3">
                                                {[7, 15, 30].map(d => (
                                                    <button
                                                        key={d}
                                                        onClick={() => setNotSoldDays(d)}
                                                        className={cn("px-2 py-1.5 border rounded text-xs", notSoldDays === d ? "bg-blue-50 border-blue-300 text-blue-700" : "hover:bg-gray-50")}
                                                    >
                                                        {d} ng√†y
                                                    </button>
                                                ))}
                                                <button
                                                    onClick={() => setNotSoldDays(null)}
                                                    className={cn("px-2 py-1.5 border rounded text-xs", notSoldDays === null ? "bg-blue-50 border-red-300 text-red-700" : "hover:bg-gray-50")}
                                                >
                                                    X√≥a
                                                </button>
                                            </div>
                                            {/* Custom Not Sold Days */}
                                            <div className="flex gap-2 mb-3">
                                                <input
                                                    type="number"
                                                    placeholder="S·ªë ng√†y..."
                                                    className="w-full px-3 py-1.5 border rounded text-sm"
                                                    onKeyDown={(e) => {
                                                        if (e.key === 'Enter') {
                                                            const val = parseInt(e.currentTarget.value);
                                                            if (val > 0) setNotSoldDays(val);
                                                        }
                                                    }}
                                                />
                                                <button
                                                    onClick={() => setNotSoldDays(-1)} // -1 for 'Never Sold'
                                                    className={cn("whitespace-nowrap px-3 py-1.5 border rounded text-xs flex items-center gap-1", notSoldDays === -1 ? "bg-blue-50 border-blue-300 text-blue-700" : "hover:bg-gray-50")}
                                                >
                                                    ‚ö†Ô∏è Ch∆∞a b√°n
                                                </button>
                                            </div>

                                            <button onClick={() => setShowSortFilter(false)} className="w-full py-2 bg-blue-500 text-white rounded-lg text-sm font-medium">√Åp d·ª•ng</button>
                                        </div>
                                    )}
                                </div>

                                {/* Save Filter */}
                                <button className="px-3 py-2 text-sm text-gray-600 hover:text-gray-800">L∆∞u b·ªô l·ªçc</button>
                            </div>
                        </div>
                    </header>
                    <main className="container-app py-6">
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            {/* Bulk Actions Bar - shows when items selected */}
                            {selectedProducts.size > 0 && (
                                <div className="px-4 py-3 bg-blue-50 border-b border-blue-100 flex items-center gap-4">
                                    <span className="text-sm text-blue-700 font-medium">
                                        ƒê√£ ch·ªçn {selectedProducts.size} s·∫£n ph·∫©m tr√™n trang n√†y
                                    </span>
                                    <div className="relative">
                                        <button
                                            onClick={() => setShowBulkActions(!showBulkActions)}
                                            className="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 flex items-center gap-2"
                                        >
                                            Ch·ªçn thao t√°c ‚ñæ
                                        </button>
                                        {showBulkActions && (
                                            <div className="absolute left-0 top-full mt-1 w-48 bg-white border rounded-lg shadow-lg z-20">
                                                <button
                                                    onClick={() => {
                                                        // Navigate to labels page with selected products
                                                        const ids = Array.from(selectedProducts).join(',');
                                                        window.location.href = `/barcode-print?products=${ids}`;
                                                        setShowBulkActions(false);
                                                    }}
                                                    className="block w-full text-left px-4 py-3 hover:bg-gray-50 border-b text-sm"
                                                >
                                                    üè∑Ô∏è In m√£ v·∫°ch
                                                </button>
                                                <button
                                                    onClick={async () => {
                                                        const ids = Array.from(selectedProducts);
                                                        for (const id of ids) {
                                                            const p = products.find(pr => pr.id === id);
                                                            if (p) await updateProduct(id, { is_active: true });
                                                        }
                                                        setShowBulkActions(false);
                                                        setSelectedProducts(new Set());
                                                    }}
                                                    className="block w-full text-left px-4 py-3 hover:bg-gray-50 border-b text-sm"
                                                >
                                                    ‚úÖ ƒêang giao d·ªãch
                                                </button>
                                                <button
                                                    onClick={async () => {
                                                        const ids = Array.from(selectedProducts);
                                                        for (const id of ids) {
                                                            const p = products.find(pr => pr.id === id);
                                                            if (p) await updateProduct(id, { is_active: false });
                                                        }
                                                        setShowBulkActions(false);
                                                        setSelectedProducts(new Set());
                                                    }}
                                                    className="block w-full text-left px-4 py-3 hover:bg-gray-50 border-b text-sm"
                                                >
                                                    ‚è∏Ô∏è Ng·ª´ng giao d·ªãch
                                                </button>
                                                <button
                                                    onClick={async () => {
                                                        const count = selectedProducts.size;
                                                        if (!window.confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${count} s·∫£n ph·∫©m ƒë√£ ch·ªçn?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                                                            return;
                                                        }
                                                        const ids = Array.from(selectedProducts);
                                                        for (const id of ids) {
                                                            await deleteProduct(id);
                                                        }
                                                        setShowBulkActions(false);
                                                        setSelectedProducts(new Set());
                                                    }}
                                                    className="block w-full text-left px-4 py-3 hover:bg-red-50 text-red-600 text-sm"
                                                >
                                                    üóëÔ∏è X√≥a s·∫£n ph·∫©m
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="bg-gray-50 border-b border-gray-200 text-xs uppercase tracking-wide text-gray-500">
                                            <th className="px-4 py-4 w-12">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedProducts.size > 0 && selectedProducts.size === paginatedProducts.length}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setSelectedProducts(new Set(paginatedProducts.map(p => p.id)));
                                                        } else {
                                                            setSelectedProducts(new Set());
                                                        }
                                                    }}
                                                    className="w-4 h-4 rounded border-gray-300"
                                                />
                                            </th>
                                            <th className="px-4 py-4">·∫¢nh</th>
                                            <th className="px-6 py-4">S·∫£n ph·∫©m</th>
                                            <th className="px-6 py-4">SKU/Barcode</th>
                                            <th className="px-6 py-4 text-right">Gi√° b√°n</th>
                                            <th className="px-6 py-4 text-center">T·ªìn kho</th>
                                            <th className="px-6 py-4 text-center">Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {isLoading ? (
                                            <tr><td colSpan={7} className="px-6 py-12 text-center text-gray-500">ƒêang t·∫£i s·∫£n ph·∫©m...</td></tr>
                                        ) : paginatedProducts.length === 0 ? (
                                            <tr><td colSpan={7} className="px-6 py-12 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</td></tr>
                                        ) : (
                                            paginatedProducts.map((product) => (
                                                <tr key={product.id} className={cn("hover:bg-gray-50 cursor-pointer transition-colors", selectedProducts.has(product.id) && "bg-blue-50")}>
                                                    <td className="px-4 py-4" onClick={(e) => e.stopPropagation()}>
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedProducts.has(product.id)}
                                                            onChange={(e) => {
                                                                const newSet = new Set(selectedProducts);
                                                                if (e.target.checked) {
                                                                    newSet.add(product.id);
                                                                } else {
                                                                    newSet.delete(product.id);
                                                                }
                                                                setSelectedProducts(newSet);
                                                            }}
                                                            className="w-4 h-4 rounded border-gray-300"
                                                        />
                                                    </td>
                                                    <td className="px-4 py-3" onClick={() => setViewingProduct(product)}>
                                                        <div className="w-16 h-16 rounded-lg bg-gray-100 border flex items-center justify-center overflow-hidden">
                                                            {product.image_url ? <img src={product.image_url} alt="" className="w-full h-full object-cover" style={{ imageRendering: 'crisp-edges' }} /> : <span className="text-gray-400 text-xl">üì¶</span>}
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4" onClick={() => setViewingProduct(product)}>
                                                        <div className="font-medium text-gray-900">{product.name}</div>
                                                        <div className="text-sm text-gray-500">{product.base_unit}</div>
                                                    </td>
                                                    <td className="px-6 py-4" onClick={() => setViewingProduct(product)}>
                                                        <div className="text-sm font-mono text-gray-600">{product.sku || '---'}</div>
                                                        <div className="text-xs text-gray-400">{product.barcode}</div>
                                                    </td>
                                                    <td className="px-6 py-4 text-right" onClick={() => setViewingProduct(product)}><span className="font-medium text-gray-900">{formatVND(product.selling_price)}</span></td>
                                                    <td className="px-6 py-4 text-center" onClick={() => setViewingProduct(product)}><span className={cn("px-2.5 py-1 rounded-full text-xs font-medium", product.current_stock <= product.min_stock ? "bg-red-100 text-red-700" : "bg-green-100 text-green-700")}>{product.current_stock}</span></td>
                                                    <td className="px-6 py-4 text-center">
                                                        <div className="flex items-center justify-center gap-2">
                                                            <button onClick={(e) => { e.stopPropagation(); handleEdit(product); }} className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors" title="S·ª≠a">
                                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                                            </button>
                                                            <button onClick={(e) => handleDelete(product, e)} className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="X√≥a">
                                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" /></svg>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            {/* Pagination */}
                            <div className="border-t px-4">
                                <Pagination
                                    currentPage={currentPage}
                                    totalItems={filteredProducts.length}
                                    pageSize={pageSize}
                                    onPageChange={setCurrentPage}
                                    onPageSizeChange={(size) => { setPageSize(size); setCurrentPage(1); }}
                                />
                            </div>
                        </div>
                    </main>

                    {/* Import Dialog */}
                    {showImport && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl shadow-xl w-[900px] h-[80vh] flex flex-col">
                                <div className="p-6 border-b flex justify-between items-center bg-gray-50">
                                    <h3 className="text-xl font-bold">X√°c nh·∫≠n nh·∫≠p li·ªáu (Preview)</h3>
                                    <button onClick={() => setShowImport(false)} className="text-gray-400 hover:text-gray-600">‚úï</button>
                                </div>
                                <div className="flex-1 overflow-auto p-6">
                                    <div className="mb-4 flex gap-4">
                                        <label className="flex items-center gap-2">Format: <select value={importFormat} onChange={(e) => setImportFormat(e.target.value as CSVFormat)} className="border rounded px-2 py-1"><option value="auto">T·ª± ƒë·ªông nh·∫≠n di·ªán</option><option value="standard">Chu·∫©n (Standard)</option><option value="kiotviet">KiotViet</option><option value="sapo">Sapo</option></select></label>
                                        <span className="text-sm text-gray-500 italic ml-auto pt-1">T√¨m th·∫•y {importPreview.length} s·∫£n ph·∫©m h·ª£p l·ªá</span>
                                    </div>
                                    <table className="w-full text-sm border-collapse border">
                                        <thead className="bg-gray-100">
                                            <tr><th className="border p-2">#</th><th className="border p-2">T√™n s·∫£n ph·∫©m</th><th className="border p-2">SKU</th><th className="border p-2">Gi√° b√°n</th><th className="border p-2">Gi√° v·ªën</th><th className="border p-2">T·ªìn</th><th className="border p-2">ƒêVT</th></tr>
                                        </thead>
                                        <tbody>
                                            {importPreview.map((p, i) => (
                                                <tr key={i} className="hover:bg-gray-50"><td className="border p-2 text-center">{i + 1}</td><td className="border p-2">{p.name}</td><td className="border p-2 font-mono">{p.sku}</td><td className="border p-2 text-right">{formatVND(p.selling_price || 0)}</td><td className="border p-2 text-right">{formatVND(p.cost_price || 0)}</td><td className="border p-2 text-center">{p.current_stock}</td><td className="border p-2 text-center">{p.base_unit}</td></tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="p-6 border-t bg-gray-50 flex justify-end gap-3">
                                    <button onClick={() => setShowImport(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">H·ªßy</button>
                                    <button onClick={handleImportConfirm} className="px-6 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">X√°c nh·∫≠n nh·∫≠p kho</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* View Details Modal */}
                    {viewingProduct && (
                        <ProductDetailsModal
                            product={viewingProduct}
                            onClose={() => setViewingProduct(null)}
                            onEdit={handleEdit}
                        />
                    )}

                    {/* ======= PRODUCT FORM - Two Column Layout ======= */}
                    {showForm && (
                        <div style={{ position: 'fixed', inset: 0, zIndex: 50, backgroundColor: '#f9fafb', overflow: 'auto' }}>
                            {/* Form Header */}
                            <div style={{ position: 'sticky', top: 0, backgroundColor: 'white', borderBottom: '1px solid #e5e7eb', padding: '16px 24px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', zIndex: 10 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                                    <button type="button" onClick={() => { setShowForm(false); setEditingProduct(null); }} style={{ padding: '8px 12px', borderRadius: '8px', border: '1px solid #e5e7eb', backgroundColor: 'white', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px' }}>‚Üê Quay l·∫°i</button>
                                    <h1 style={{ fontSize: '18px', fontWeight: 'bold', margin: 0 }}>{editingProduct ? '‚úèÔ∏è S·ª≠a s·∫£n ph·∫©m' : '‚ûï Th√™m s·∫£n ph·∫©m'}</h1>
                                </div>
                                <div style={{ display: 'flex', gap: '12px' }}>
                                    <button type="button" onClick={() => { setShowForm(false); setEditingProduct(null); }} style={{ padding: '10px 20px', borderRadius: '8px', border: '1px solid #d1d5db', backgroundColor: 'white', color: '#374151', fontWeight: 600, cursor: 'pointer' }}>H·ªßy</button>
                                    <button type="submit" form="product-form" style={{ padding: '10px 20px', borderRadius: '8px', border: 'none', background: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)', color: 'white', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 12px rgba(34, 197, 94, 0.3)' }}>{editingProduct ? 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m' : 'Th√™m s·∫£n ph·∫©m'}</button>
                                </div>
                            </div>

                            {/* Form Content - Two Columns */}
                            <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>
                                <form
                                    id="product-form"
                                    onSubmit={(e) => {
                                        e.preventDefault();
                                        const formData = new FormData(e.currentTarget);
                                        const data: any = Object.fromEntries(formData.entries());

                                        // Use autoGeneratedSKU if SKU is empty (for new product)
                                        const sku = data.sku || autoGeneratedSKU || undefined;
                                        // Use SKU as barcode if barcode is empty
                                        const barcode = data.barcode || sku || undefined;

                                        handleSave({
                                            name: data.name,
                                            sku: sku,
                                            barcode: barcode,
                                            selling_price: Number(data.selling_price) || 0,
                                            wholesale_price: Number(data.wholesale_price) || undefined,
                                            purchase_price: Number(data.purchase_price) || 0,
                                            cost_price: Number(data.cost_price) || Number(data.purchase_price) || 0,
                                            current_stock: Number(data.current_stock) || 0,
                                            min_stock: Number(data.min_stock) || 5,
                                            base_unit: baseUnit,
                                            image_url: data.image_url || undefined,
                                            description: data.description || undefined,
                                            weight: Number(data.weight) || undefined,
                                            exclude_from_loyalty_points: data.exclude_from_loyalty_points === 'on',
                                        });
                                    }}
                                    style={{ display: 'grid', gridTemplateColumns: '1fr 380px', gap: '24px', alignItems: 'start' }}
                                >
                                    {/* ===== LEFT COLUMN ===== */}
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                        {/* Th√¥ng tin s·∫£n ph·∫©m */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '20px' }}>
                                            <h2 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '16px', color: '#111827' }}>Th√¥ng tin s·∫£n ph·∫©m</h2>

                                            <div style={{ marginBottom: '16px' }}>
                                                <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>
                                                    T√™n s·∫£n ph·∫©m <span style={{ color: '#dc2626' }}>*</span>
                                                </label>
                                                <input
                                                    name="name"
                                                    defaultValue={editingProduct?.name || ''}
                                                    required
                                                    placeholder="‚úèÔ∏è Nh·∫≠p t√™n s·∫£n ph·∫©m (t·ªëi ƒëa 320 k√Ω t·ª±)"
                                                    style={{
                                                        width: '100%',
                                                        padding: '12px 16px',
                                                        borderRadius: '8px',
                                                        border: '1px solid #e5e7eb',
                                                        fontSize: '14px',
                                                        boxSizing: 'border-box'
                                                    }}
                                                />
                                            </div>

                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                                <div>
                                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>M√£ SKU</label>
                                                    <div style={{ position: 'relative' }}>
                                                        <input
                                                            id="sku-input"
                                                            name="sku"
                                                            defaultValue={editingProduct?.sku || autoGeneratedSKU}
                                                            placeholder="PVN0001"
                                                            onBlur={(e) => {
                                                                // Check uniqueness
                                                                const val = e.target.value;
                                                                if (!val) return;
                                                                const exists = products.some(p => p.sku === val && p.id !== editingProduct?.id);
                                                                if (exists) {
                                                                    e.target.style.borderColor = '#ef4444';
                                                                    alert('M√£ SKU ƒë√£ t·ªìn t·∫°i! Vui l√≤ng s·ª≠ d·ª•ng m√£ kh√°c.');
                                                                } else {
                                                                    e.target.style.borderColor = '#e5e7eb';
                                                                }
                                                            }}
                                                            style={{
                                                                width: '100%',
                                                                padding: '12px 44px 12px 16px',
                                                                borderRadius: '8px',
                                                                border: '1px solid #e5e7eb',
                                                                fontSize: '14px',
                                                                boxSizing: 'border-box'
                                                            }}
                                                        />
                                                        {/* SKU scan icon */}
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                if (!navigator.mediaDevices) {
                                                                    alert('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ camera');
                                                                    return;
                                                                }
                                                                const modal = document.createElement('div');
                                                                modal.id = 'sku-scanner-modal';
                                                                modal.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;';
                                                                modal.innerHTML = `
                                                            <div style="width:100%;max-width:360px;text-align:center;">
                                                                <video id="sku-video" style="width:100%;border-radius:12px;background:#000;" autoplay playsinline></video>
                                                                <p id="sku-scan-status" style="color:white;margin:12px 0;font-size:14px;">ƒêang m·ªü camera...</p>
                                                                <button id="close-sku-scanner" style="padding:12px 32px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;">‚úï ƒê√≥ng</button>
                                                            </div>
                                                        `;
                                                                document.body.appendChild(modal);
                                                                const video = document.getElementById('sku-video') as HTMLVideoElement;
                                                                const statusEl = document.getElementById('sku-scan-status') as HTMLElement;
                                                                const closeBtn = document.getElementById('close-sku-scanner') as HTMLButtonElement;
                                                                let stream: MediaStream | null = null;
                                                                const cleanup = () => { if (stream) stream.getTracks().forEach(t => t.stop()); modal.remove(); };
                                                                closeBtn.onclick = cleanup;
                                                                modal.onclick = (e) => { if (e.target === modal) cleanup(); };
                                                                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                                                                    .then(async (s) => {
                                                                        stream = s;
                                                                        video.srcObject = stream;
                                                                        statusEl.textContent = 'H∆∞·ªõng camera v√†o m√£ SKU...';
                                                                        if ('BarcodeDetector' in window) {
                                                                            const detector = new (window as any).BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39', 'qr_code'] });
                                                                            const detect = async () => {
                                                                                if (!video.srcObject) return;
                                                                                try {
                                                                                    const barcodes = await detector.detect(video);
                                                                                    if (barcodes.length > 0) {
                                                                                        (document.getElementById('sku-input') as HTMLInputElement).value = barcodes[0].rawValue;
                                                                                        statusEl.innerHTML = '<span style="color:#22c55e;">‚úÖ ' + barcodes[0].rawValue + '</span>';
                                                                                        setTimeout(cleanup, 800);
                                                                                        return;
                                                                                    }
                                                                                } catch (e) { }
                                                                                requestAnimationFrame(detect);
                                                                            };
                                                                            detect();
                                                                        } else {
                                                                            statusEl.innerHTML = '<span style="color:#fbbf24;">‚ö†Ô∏è Tr√¨nh duy·ªát ch∆∞a h·ªó tr·ª£ qu√©t t·ª± ƒë·ªông</span>';
                                                                        }
                                                                    })
                                                                    .catch(() => { statusEl.innerHTML = '<span style="color:#ef4444;">‚ùå Kh√¥ng th·ªÉ m·ªü camera</span>'; });
                                                            }}
                                                            style={{
                                                                position: 'absolute',
                                                                right: '8px',
                                                                top: '50%',
                                                                transform: 'translateY(-50%)',
                                                                background: 'none',
                                                                border: 'none',
                                                                cursor: 'pointer',
                                                                padding: '4px',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center'
                                                            }}
                                                            title="Qu√©t m√£ SKU"
                                                        >
                                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                                                                <path d="M3 5V3h4M17 3h4v2M3 19v2h4M17 21h4v-2" />
                                                                <path d="M7 7v10M11 7v10M15 7v10M19 7v10" strokeWidth="1.5" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>M√£ v·∫°ch/ Barcode</label>
                                                    <div style={{ position: 'relative' }}>
                                                        <input
                                                            id="barcode-input"
                                                            name="barcode"
                                                            defaultValue={editingProduct?.barcode || ''}
                                                            placeholder="Nh·∫≠p ho·∫∑c qu√©t m√£ v·∫°ch"
                                                            onChange={(e) => {
                                                                const barcodeValue = e.target.value.trim();
                                                                const skuInput = document.getElementById('sku-input') as HTMLInputElement;
                                                                const skuValue = skuInput?.value || autoGeneratedSKU || '';
                                                                // Barcode is "real" only if not empty AND different from SKU
                                                                const hasRealBarcode = barcodeValue !== '' && barcodeValue !== skuValue;
                                                                if (!hasRealBarcode) {
                                                                    // Auto-check Kh√¥ng m√£ category
                                                                    if (!selectedCategories.includes(NO_BARCODE_CATEGORY_ID)) {
                                                                        setSelectedCategories([...selectedCategories, NO_BARCODE_CATEGORY_ID]);
                                                                    }
                                                                } else {
                                                                    // Auto-uncheck Kh√¥ng m√£ category
                                                                    if (selectedCategories.includes(NO_BARCODE_CATEGORY_ID)) {
                                                                        setSelectedCategories(selectedCategories.filter(id => id !== NO_BARCODE_CATEGORY_ID));
                                                                    }
                                                                }
                                                            }}
                                                            style={{
                                                                width: '100%',
                                                                padding: '12px 44px 12px 16px',
                                                                borderRadius: '8px',
                                                                border: '1px solid #e5e7eb',
                                                                fontSize: '14px',
                                                                boxSizing: 'border-box'
                                                            }}
                                                        />
                                                        {/* Barcode scan icon */}
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                if (!navigator.mediaDevices) {
                                                                    alert('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ camera');
                                                                    return;
                                                                }
                                                                const modal = document.createElement('div');
                                                                modal.id = 'barcode-scanner-modal';
                                                                modal.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;';
                                                                modal.innerHTML = `
                                                            <div style="width:100%;max-width:360px;text-align:center;">
                                                                <video id="barcode-video" style="width:100%;border-radius:12px;background:#000;" autoplay playsinline></video>
                                                                <p id="scan-status" style="color:white;margin:12px 0;font-size:14px;">ƒêang m·ªü camera...</p>
                                                                <button id="close-scanner" style="padding:12px 32px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;">‚úï ƒê√≥ng</button>
                                                            </div>
                                                        `;
                                                                document.body.appendChild(modal);
                                                                const video = document.getElementById('barcode-video') as HTMLVideoElement;
                                                                const statusEl = document.getElementById('scan-status') as HTMLElement;
                                                                const closeBtn = document.getElementById('close-scanner') as HTMLButtonElement;
                                                                let stream: MediaStream | null = null;
                                                                const cleanup = () => { if (stream) stream.getTracks().forEach(t => t.stop()); modal.remove(); };
                                                                closeBtn.onclick = cleanup;
                                                                modal.onclick = (e) => { if (e.target === modal) cleanup(); };
                                                                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                                                                    .then(async (s) => {
                                                                        stream = s;
                                                                        video.srcObject = stream;
                                                                        statusEl.textContent = 'H∆∞·ªõng camera v√†o m√£ v·∫°ch...';
                                                                        if ('BarcodeDetector' in window) {
                                                                            const detector = new (window as any).BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39', 'qr_code'] });
                                                                            const detect = async () => {
                                                                                if (!video.srcObject) return;
                                                                                try {
                                                                                    const barcodes = await detector.detect(video);
                                                                                    if (barcodes.length > 0) {
                                                                                        (document.getElementById('barcode-input') as HTMLInputElement).value = barcodes[0].rawValue;
                                                                                        statusEl.innerHTML = '<span style="color:#22c55e;">‚úÖ ' + barcodes[0].rawValue + '</span>';
                                                                                        setTimeout(cleanup, 800);
                                                                                        return;
                                                                                    }
                                                                                } catch (e) { }
                                                                                requestAnimationFrame(detect);
                                                                            };
                                                                            detect();
                                                                        } else {
                                                                            statusEl.innerHTML = '<span style="color:#fbbf24;">‚ö†Ô∏è Tr√¨nh duy·ªát ch∆∞a h·ªó tr·ª£ qu√©t t·ª± ƒë·ªông</span>';
                                                                        }
                                                                    })
                                                                    .catch(() => { statusEl.innerHTML = '<span style="color:#ef4444;">‚ùå Kh√¥ng th·ªÉ m·ªü camera</span>'; });
                                                            }}
                                                            style={{
                                                                position: 'absolute',
                                                                right: '8px',
                                                                top: '50%',
                                                                transform: 'translateY(-50%)',
                                                                background: 'none',
                                                                border: 'none',
                                                                cursor: 'pointer',
                                                                padding: '4px',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center'
                                                            }}
                                                            title="Qu√©t m√£ v·∫°ch"
                                                        >
                                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                                                                <path d="M3 5V3h4M17 3h4v2M3 19v2h4M17 21h4v-2" />
                                                                <path d="M7 7v10M11 7v10M15 7v10M19 7v10" strokeWidth="1.5" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <div style={{ marginBottom: '16px' }}>
                                                <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>ƒê∆°n v·ªã t√≠nh</label>
                                                <div style={{ width: '50%' }}>
                                                    <UnitSuggestDropdown
                                                        value={baseUnit}
                                                        onChange={setBaseUnit}
                                                        placeholder="Ch·ªçn ƒë∆°n v·ªã t√≠nh"
                                                    />
                                                </div>
                                            </div>

                                            <div>
                                                <button
                                                    type="button"
                                                    onClick={() => setShowDescription(!showDescription)}
                                                    style={{
                                                        display: 'flex', alignItems: 'center', gap: '8px',
                                                        fontSize: '14px', fontWeight: 500, color: '#374151',
                                                        background: 'none', border: 'none', cursor: 'pointer',
                                                        padding: 0, marginBottom: showDescription ? '6px' : 0
                                                    }}
                                                >
                                                    <span style={{
                                                        display: 'inline-block',
                                                        transform: showDescription ? 'rotate(90deg)' : 'rotate(0deg)',
                                                        transition: 'transform 0.2s'
                                                    }}>‚ñ∂</span>
                                                    M√¥ t·∫£
                                                </button>
                                                {showDescription && (
                                                    <>
                                                        <textarea
                                                            name="description"
                                                            defaultValue={editingProduct?.description || ''}
                                                            placeholder="Nh·∫≠p m√¥ t·∫£ s·∫£n ph·∫©m..."
                                                            style={{
                                                                width: '100%',
                                                                padding: '12px 16px',
                                                                borderRadius: '8px',
                                                                border: '1px solid #e5e7eb',
                                                                fontSize: '14px',
                                                                minHeight: '120px',
                                                                resize: 'vertical',
                                                                boxSizing: 'border-box'
                                                            }}
                                                        />
                                                        <p style={{ fontSize: '12px', color: '#9ca3af', marginTop: '4px', textAlign: 'right' }}>HTML: 0/100000</p>
                                                    </>
                                                )}
                                            </div>
                                        </div>

                                        {/* Th√¥ng tin gi√° */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '20px' }}>
                                            <h2 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '16px', color: '#111827' }}>Th√¥ng tin gi√°</h2>

                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                                <div>
                                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>Gi√° b√°n</label>
                                                    <div style={{ position: 'relative' }}>
                                                        <CurrencyInput
                                                            name="selling_price"
                                                            defaultValue={editingProduct?.selling_price || ''}
                                                            placeholder="Nh·∫≠p gi√° b√°n s·∫£n ph·∫©m"
                                                            style={{
                                                                padding: '12px 40px 12px 16px',
                                                                borderRadius: '8px',
                                                                border: '1px solid #e5e7eb',
                                                                fontSize: '14px',
                                                                boxSizing: 'border-box'
                                                            }}
                                                        />
                                                        <span style={{ position: 'absolute', right: '12px', top: '50%', transform: 'translateY(-50%)', color: '#9ca3af' }}>ƒë</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>
                                                        Gi√° b√°n bu√¥n <span style={{ color: '#9ca3af', fontSize: '12px' }}>üì¶ ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng √°p d·ª•ng</span>
                                                    </label>
                                                    <div style={{ position: 'relative' }}>
                                                        <CurrencyInput
                                                            name="wholesale_price"
                                                            defaultValue={editingProduct?.wholesale_price || ''}
                                                            placeholder="Nh·∫≠p gi√° b√°n bu√¥n (t√πy ch·ªçn)"
                                                            style={{
                                                                padding: '12px 40px 12px 16px',
                                                                borderRadius: '8px',
                                                                border: '1px solid #e5e7eb',
                                                                fontSize: '14px',
                                                                boxSizing: 'border-box'
                                                            }}
                                                        />
                                                        <span style={{ position: 'absolute', right: '12px', top: '50%', transform: 'translateY(-50%)', color: '#9ca3af' }}>ƒë</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                                <div>
                                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>
                                                        Gi√° nh·∫≠p <span style={{ color: '#9ca3af' }}>‚ìò D√πng cho ƒë∆°n nh·∫≠p h√†ng</span>
                                                    </label>
                                                    <div style={{ position: 'relative' }}>
                                                        <CurrencyInput
                                                            name="purchase_price"
                                                            defaultValue={editingProduct?.purchase_price || editingProduct?.cost_price || ''}
                                                            placeholder="Nh·∫≠p gi√° nh·∫≠p s·∫£n ph·∫©m"
                                                            style={{
                                                                padding: '12px 40px 12px 16px',
                                                                borderRadius: '8px',
                                                                border: '1px solid #e5e7eb',
                                                                fontSize: '14px',
                                                                boxSizing: 'border-box'
                                                            }}
                                                        />
                                                        <span style={{ position: 'absolute', right: '12px', top: '50%', transform: 'translateY(-50%)', color: '#9ca3af' }}>ƒë</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>
                                                        Gi√° v·ªën <span style={{ color: '#9ca3af' }}>‚ìò T√≠nh t·ª± ƒë·ªông</span>
                                                    </label>
                                                    <div style={{ position: 'relative' }}>
                                                        <CurrencyInput
                                                            name="cost_price"
                                                            defaultValue={editingProduct?.avg_cost_price || editingProduct?.cost_price || ''}
                                                            placeholder="T·ª± ƒë·ªông t√≠nh t·ª´ gi√° nh·∫≠p"
                                                            readOnly={!!editingProduct}
                                                            style={{
                                                                padding: '12px 40px 12px 16px',
                                                                borderRadius: '8px',
                                                                border: '1px solid #e5e7eb',
                                                                fontSize: '14px',
                                                                boxSizing: 'border-box',
                                                                backgroundColor: editingProduct ? '#f3f4f6' : 'white'
                                                            }}
                                                        />
                                                        <span style={{ position: 'absolute', right: '12px', top: '50%', transform: 'translateY(-50%)', color: '#9ca3af' }}>ƒë</span>
                                                    </div>
                                                    {editingProduct && editingProduct.avg_cost_price && (
                                                        <p style={{ fontSize: '12px', color: '#6b7280', marginTop: '4px' }}>
                                                            Gi√° v·ªën b√¨nh qu√¢n: {editingProduct.avg_cost_price.toLocaleString()}ƒë
                                                        </p>
                                                    )}
                                                </div>
                                            </div>

                                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                                                <input type="checkbox" name="apply_tax" style={{ width: '18px', height: '18px' }} />
                                                <span style={{ fontSize: '14px', color: '#374151' }}>√Åp d·ª•ng thu·∫ø</span>
                                            </label>
                                        </div>

                                        {/* ƒê∆°n v·ªã quy ƒë·ªïi - Collapsible */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '24px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: showUnitsSection || units.length > 0 ? '16px' : 0 }}>
                                                <button
                                                    type="button"
                                                    onClick={() => setShowUnitsSection(!showUnitsSection)}
                                                    style={{
                                                        display: 'flex', alignItems: 'center', gap: '8px',
                                                        fontSize: '16px', fontWeight: 600, color: '#111827',
                                                        background: 'none', border: 'none', cursor: 'pointer',
                                                        padding: 0
                                                    }}
                                                >
                                                    <span style={{
                                                        display: 'inline-block',
                                                        transform: (showUnitsSection || units.length > 0) ? 'rotate(90deg)' : 'rotate(0deg)',
                                                        transition: 'transform 0.2s',
                                                        fontSize: '12px'
                                                    }}>‚ñ∂</span>
                                                    ƒê∆°n v·ªã quy ƒë·ªïi
                                                    {units.length > 0 && <span style={{ fontSize: '14px', color: '#6b7280', fontWeight: 400 }}>({units.length} ƒë∆°n v·ªã)</span>}
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setShowUnitsSection(true);
                                                        handleAddUnit();
                                                    }}
                                                    style={{
                                                        fontSize: '14px', color: '#2563eb', fontWeight: 600,
                                                        background: 'none', border: 'none', cursor: 'pointer',
                                                        display: 'flex', alignItems: 'center', gap: '4px'
                                                    }}
                                                >
                                                    + Th√™m ƒë∆°n v·ªã
                                                </button>
                                            </div>

                                            {(showUnitsSection || units.length > 0) && (
                                                <p style={{ fontSize: '13px', color: '#6b7280', marginBottom: '20px', lineHeight: '1.5' }}>
                                                    V√≠ d·ª•: 1 Th√πng = 24 Lon. Gi√° b√°n theo ƒë∆°n v·ªã s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng khi b√°n.
                                                </p>
                                            )}

                                            {units.length > 0 ? (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                                    {units.map((unit, idx) => (
                                                        <div key={idx} style={{
                                                            padding: '20px',
                                                            borderRadius: '12px',
                                                            backgroundColor: '#f8fafc',
                                                            border: '1px solid #e2e8f0',
                                                            position: 'relative'
                                                        }}>
                                                            {/* Delete button */}
                                                            <button
                                                                type="button"
                                                                onClick={() => handleRemoveUnit(idx)}
                                                                style={{
                                                                    position: 'absolute',
                                                                    top: '12px',
                                                                    right: '12px',
                                                                    color: '#ef4444',
                                                                    background: 'white',
                                                                    border: '1px solid #fecaca',
                                                                    borderRadius: '6px',
                                                                    width: '28px',
                                                                    height: '28px',
                                                                    cursor: 'pointer',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    justifyContent: 'center',
                                                                    fontSize: '14px'
                                                                }}
                                                                title="X√≥a ƒë∆°n v·ªã"
                                                            >
                                                                ‚úï
                                                            </button>

                                                            {/* Row 1: T√™n ƒë∆°n v·ªã + Quy ƒë·ªïi */}
                                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                                                <div>
                                                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, color: '#374151', marginBottom: '6px' }}>
                                                                        T√™n ƒë∆°n v·ªã
                                                                    </label>
                                                                    <input
                                                                        placeholder="Vd: Th√πng, L·ªëc, H·ªôp..."
                                                                        value={unit.unit_name}
                                                                        onChange={(e) => handleUpdateUnit(idx, 'unit_name', e.target.value)}
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '10px 12px',
                                                                            borderRadius: '8px',
                                                                            border: '1px solid #d1d5db',
                                                                            fontSize: '14px',
                                                                            backgroundColor: 'white'
                                                                        }}
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, color: '#374151', marginBottom: '6px' }}>
                                                                        S·ªë l∆∞·ª£ng quy ƒë·ªïi *
                                                                    </label>
                                                                    <input
                                                                        type="number"
                                                                        min="1"
                                                                        value={unit.conversion_rate}
                                                                        onChange={(e) => handleUpdateUnit(idx, 'conversion_rate', Number(e.target.value))}
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '10px 12px',
                                                                            borderRadius: '8px',
                                                                            border: '1px solid #d1d5db',
                                                                            fontSize: '14px',
                                                                            backgroundColor: 'white'
                                                                        }}
                                                                    />
                                                                </div>
                                                            </div>

                                                            {/* Row 2: M√£ SKU + M√£ v·∫°ch */}
                                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                                                <div>
                                                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, color: '#374151', marginBottom: '6px' }}>
                                                                        M√£ SKU
                                                                    </label>
                                                                    <div style={{ position: 'relative' }}>
                                                                        <input
                                                                            placeholder="Nh·∫≠p m√£ SKU"
                                                                            value={unit.sku || ''}
                                                                            onChange={(e) => handleUpdateUnit(idx, 'sku', e.target.value)}
                                                                            onKeyDown={(e) => {
                                                                                if (e.key === 'Enter') e.preventDefault();
                                                                            }}
                                                                            style={{
                                                                                width: '100%',
                                                                                padding: '10px 40px 10px 12px',
                                                                                borderRadius: '8px',
                                                                                border: '1px solid #d1d5db',
                                                                                fontSize: '14px',
                                                                                backgroundColor: 'white',
                                                                                boxSizing: 'border-box'
                                                                            }}
                                                                        />
                                                                        <button
                                                                            type="button"
                                                                            title="Qu√©t m√£ SKU"
                                                                            onClick={() => openBarcodeScanner((code) => handleUpdateUnit(idx, 'sku', code), 'm√£ SKU')}
                                                                            style={{
                                                                                position: 'absolute',
                                                                                right: '8px',
                                                                                top: '50%',
                                                                                transform: 'translateY(-50%)',
                                                                                background: 'none',
                                                                                border: 'none',
                                                                                cursor: 'pointer',
                                                                                padding: '4px',
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                justifyContent: 'center'
                                                                            }}
                                                                        >
                                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                                                                                <path d="M3 5V3h4M17 3h4v2M3 19v2h4M17 21h4v-2" />
                                                                                <path d="M7 7v10M11 7v10M15 7v10M19 7v10" strokeWidth="1.5" />
                                                                            </svg>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, color: '#374151', marginBottom: '6px' }}>
                                                                        M√£ v·∫°ch/Barcode
                                                                    </label>
                                                                    <div style={{ position: 'relative' }}>
                                                                        <input
                                                                            placeholder="Nh·∫≠p m√£ v·∫°ch"
                                                                            value={unit.barcode || ''}
                                                                            onChange={(e) => handleUpdateUnit(idx, 'barcode', e.target.value)}
                                                                            onKeyDown={(e) => {
                                                                                if (e.key === 'Enter') e.preventDefault();
                                                                            }}
                                                                            style={{
                                                                                width: '100%',
                                                                                padding: '10px 40px 10px 12px',
                                                                                borderRadius: '8px',
                                                                                border: '1px solid #d1d5db',
                                                                                fontSize: '14px',
                                                                                backgroundColor: 'white',
                                                                                boxSizing: 'border-box'
                                                                            }}
                                                                        />
                                                                        <button
                                                                            type="button"
                                                                            title="Qu√©t m√£ v·∫°ch"
                                                                            onClick={() => openBarcodeScanner((code) => handleUpdateUnit(idx, 'barcode', code), 'm√£ v·∫°ch')}
                                                                            style={{
                                                                                position: 'absolute',
                                                                                right: '8px',
                                                                                top: '50%',
                                                                                transform: 'translateY(-50%)',
                                                                                background: 'none',
                                                                                border: 'none',
                                                                                cursor: 'pointer',
                                                                                padding: '4px',
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                justifyContent: 'center'
                                                                            }}
                                                                        >
                                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                                                                                <path d="M3 5V3h4M17 3h4v2M3 19v2h4M17 21h4v-2" />
                                                                                <path d="M7 7v10M11 7v10M15 7v10M19 7v10" strokeWidth="1.5" />
                                                                            </svg>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* Row 3: Gi√° b√°n + ·∫¢nh ƒë∆°n v·ªã */}
                                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                                                <div>
                                                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, color: '#374151', marginBottom: '6px' }}>
                                                                        Gi√° b√°n l·∫ª
                                                                    </label>
                                                                    <CurrencyInput
                                                                        placeholder="0"
                                                                        value={unit.selling_price || ''}
                                                                        onValueChange={(val) => handleUpdateUnit(idx, 'selling_price', val)}
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '10px 12px',
                                                                            borderRadius: '8px',
                                                                            border: '1px solid #d1d5db',
                                                                            fontSize: '14px',
                                                                            backgroundColor: 'white'
                                                                        }}
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, color: '#374151', marginBottom: '6px' }}>
                                                                        ·∫¢nh ƒë∆°n v·ªã
                                                                    </label>
                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                                        {unit.image_url ? (
                                                                            <div style={{ position: 'relative' }}>
                                                                                <img
                                                                                    src={unit.image_url}
                                                                                    alt={unit.unit_name}
                                                                                    onClick={() => setShowImageZoom(unit.image_url || '')}
                                                                                    style={{
                                                                                        width: '80px',
                                                                                        height: '80px',
                                                                                        objectFit: 'cover',
                                                                                        borderRadius: '8px',
                                                                                        border: '1px solid #e5e7eb',
                                                                                        cursor: 'zoom-in'
                                                                                    }}
                                                                                />
                                                                                <button
                                                                                    type="button"
                                                                                    onClick={() => handleUpdateUnit(idx, 'image_url', '')}
                                                                                    style={{
                                                                                        position: 'absolute',
                                                                                        top: '-6px',
                                                                                        right: '-6px',
                                                                                        width: '20px',
                                                                                        height: '20px',
                                                                                        borderRadius: '50%',
                                                                                        background: '#ef4444',
                                                                                        color: 'white',
                                                                                        border: 'none',
                                                                                        cursor: 'pointer',
                                                                                        fontSize: '10px',
                                                                                        display: 'flex',
                                                                                        alignItems: 'center',
                                                                                        justifyContent: 'center'
                                                                                    }}
                                                                                >
                                                                                    ‚úï
                                                                                </button>
                                                                            </div>
                                                                        ) : (
                                                                            <label style={{
                                                                                width: '80px',
                                                                                height: '80px',
                                                                                border: '2px dashed #d1d5db',
                                                                                borderRadius: '8px',
                                                                                display: 'flex',
                                                                                flexDirection: 'column',
                                                                                alignItems: 'center',
                                                                                justifyContent: 'center',
                                                                                cursor: 'pointer',
                                                                                backgroundColor: '#fafafa'
                                                                            }}>
                                                                                <input
                                                                                    type="file"
                                                                                    accept="image/*"
                                                                                    style={{ display: 'none' }}
                                                                                    onChange={(e) => {
                                                                                        const file = e.target.files?.[0];
                                                                                        if (file) {
                                                                                            const reader = new FileReader();
                                                                                            reader.onload = (ev) => {
                                                                                                handleUpdateUnit(idx, 'image_url', ev.target?.result as string);
                                                                                            };
                                                                                            reader.readAsDataURL(file);
                                                                                        }
                                                                                    }}
                                                                                />
                                                                                <span style={{ fontSize: '24px', color: '#9ca3af' }}>üì∑</span>
                                                                                <span style={{ fontSize: '10px', color: '#9ca3af', marginTop: '2px' }}>T·∫£i ·∫£nh</span>
                                                                            </label>
                                                                        )}
                                                                        <p style={{ fontSize: '12px', color: '#9ca3af', margin: 0 }}>
                                                                            Click v√†o ·∫£nh ƒë·ªÉ ph√≥ng to
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : showUnitsSection ? (
                                                <div style={{
                                                    textAlign: 'center',
                                                    padding: '32px',
                                                    color: '#9ca3af',
                                                    border: '2px dashed #e5e7eb',
                                                    borderRadius: '12px',
                                                    backgroundColor: '#fafafa'
                                                }}>
                                                    <div style={{ fontSize: '32px', marginBottom: '8px' }}>üì¶</div>
                                                    <p style={{ margin: 0, fontSize: '14px' }}>Ch∆∞a c√≥ ƒë∆°n v·ªã quy ƒë·ªïi n√†o</p>
                                                    <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#b1b1b1' }}>
                                                        Nh·∫•n "+ Th√™m ƒë∆°n v·ªã" ƒë·ªÉ th√™m ƒë∆°n v·ªã quy ƒë·ªïi
                                                    </p>
                                                </div>
                                            ) : null}
                                        </div>

                                        {/* Phi√™n b·∫£n s·∫£n ph·∫©m - Collapsible */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '24px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: (showVariantsSection || variants.length > 0) ? '16px' : 0 }}>
                                                <button
                                                    type="button"
                                                    onClick={() => setShowVariantsSection(!showVariantsSection)}
                                                    style={{
                                                        display: 'flex', alignItems: 'center', gap: '8px',
                                                        fontSize: '16px', fontWeight: 600, color: '#111827',
                                                        background: 'none', border: 'none', cursor: 'pointer',
                                                        padding: 0
                                                    }}
                                                >
                                                    <span style={{
                                                        display: 'inline-block',
                                                        transform: (showVariantsSection || variants.length > 0) ? 'rotate(90deg)' : 'rotate(0deg)',
                                                        transition: 'transform 0.2s',
                                                        fontSize: '12px'
                                                    }}>‚ñ∂</span>
                                                    Phi√™n b·∫£n s·∫£n ph·∫©m
                                                    {variants.length > 0 && <span style={{ fontSize: '14px', color: '#6b7280', fontWeight: 400 }}>({variants.length} phi√™n b·∫£n)</span>}
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setShowVariantsSection(true);
                                                        const newSku = generateUniqueSKU();
                                                        setVariants([...variants, {
                                                            id: `variant-${Date.now()}`,
                                                            name: '',
                                                            sku: newSku,
                                                            barcode: newSku,
                                                            selling_price: 0,
                                                            conversion_rate: 1,
                                                            image_url: ''
                                                        }]);
                                                    }}
                                                    style={{
                                                        fontSize: '14px', color: '#2563eb', fontWeight: 600,
                                                        background: 'none', border: 'none', cursor: 'pointer',
                                                        display: 'flex', alignItems: 'center', gap: '4px'
                                                    }}
                                                >
                                                    + Th√™m phi√™n b·∫£n
                                                </button>
                                            </div>

                                            {(showVariantsSection || variants.length > 0) && (
                                                <p style={{ fontSize: '13px', color: '#6b7280', marginBottom: '20px', lineHeight: '1.5' }}>
                                                    T·∫°o c√°c phi√™n b·∫£n nh∆∞ L·ªëc 6, Th√πng 24, Combo 2+1, v.v.
                                                </p>
                                            )}

                                            {variants.length > 0 ? (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                                    {variants.map((variant, idx) => (
                                                        <div key={variant.id} style={{
                                                            padding: '16px 20px',
                                                            borderRadius: '12px',
                                                            backgroundColor: '#f8fafc',
                                                            border: '1px solid #e2e8f0',
                                                            position: 'relative'
                                                        }}>
                                                            {/* Delete button */}
                                                            <button
                                                                type="button"
                                                                onClick={() => {
                                                                    const newVariants = [...variants];
                                                                    newVariants.splice(idx, 1);
                                                                    setVariants(newVariants);
                                                                }}
                                                                style={{
                                                                    position: 'absolute',
                                                                    top: '12px',
                                                                    right: '12px',
                                                                    color: '#ef4444',
                                                                    background: 'white',
                                                                    border: '1px solid #fecaca',
                                                                    borderRadius: '6px',
                                                                    width: '28px',
                                                                    height: '28px',
                                                                    cursor: 'pointer',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    justifyContent: 'center',
                                                                    fontSize: '12px'
                                                                }}
                                                                title="X√≥a phi√™n b·∫£n"
                                                            >
                                                                ‚úï
                                                            </button>

                                                            {/* 2 column grid */}
                                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                                                {/* T√™n phi√™n b·∫£n */}
                                                                <div>
                                                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>
                                                                        T√™n phi√™n b·∫£n
                                                                    </label>
                                                                    <input
                                                                        placeholder="VD: L·ªëc 6, Th√πng 24"
                                                                        value={variant.name}
                                                                        onChange={(e) => {
                                                                            const newVariants = [...variants];
                                                                            newVariants[idx].name = e.target.value;
                                                                            setVariants(newVariants);
                                                                        }}
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '10px 12px',
                                                                            borderRadius: '8px',
                                                                            border: '1px solid #d1d5db',
                                                                            fontSize: '14px',
                                                                            backgroundColor: 'white',
                                                                            boxSizing: 'border-box'
                                                                        }}
                                                                    />
                                                                </div>

                                                                {/* Gi√° b√°n */}
                                                                <div>
                                                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>
                                                                        Gi√° b√°n
                                                                    </label>
                                                                    <div style={{ position: 'relative' }}>
                                                                        <CurrencyInput
                                                                            value={variant.selling_price}
                                                                            onValueChange={(val: number) => {
                                                                                const newVariants = [...variants];
                                                                                newVariants[idx].selling_price = val;
                                                                                setVariants(newVariants);
                                                                            }}
                                                                            placeholder="0"
                                                                            style={{
                                                                                padding: '10px 32px 10px 12px',
                                                                                borderRadius: '8px',
                                                                                border: '1px solid #d1d5db',
                                                                                fontSize: '14px',
                                                                                boxSizing: 'border-box'
                                                                            }}
                                                                        />
                                                                        <span style={{ position: 'absolute', right: '12px', top: '50%', transform: 'translateY(-50%)', color: '#9ca3af', fontSize: '13px' }}>ƒë</span>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* S·ªë l∆∞·ª£ng quy ƒë·ªïi */}
                                                            <div style={{ marginBottom: '16px' }}>
                                                                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>
                                                                    S·ªë l∆∞·ª£ng quy ƒë·ªïi <span style={{ fontSize: '12px', color: '#9ca3af', fontWeight: 400 }}>(VD: 1 Th√πng = 24 ƒë∆°n v·ªã c∆° b·∫£n)</span>
                                                                </label>
                                                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                                    <span style={{ fontSize: '14px', color: '#6b7280' }}>1 {variant.name || 'phi√™n b·∫£n'} =</span>
                                                                    <input
                                                                        type="number"
                                                                        min="1"
                                                                        value={variant.conversion_rate || 1}
                                                                        onChange={(e) => {
                                                                            const newVariants = [...variants];
                                                                            newVariants[idx].conversion_rate = parseFloat(e.target.value) || 1;
                                                                            setVariants(newVariants);
                                                                        }}
                                                                        style={{
                                                                            width: '100px',
                                                                            padding: '10px 12px',
                                                                            borderRadius: '8px',
                                                                            border: '1px solid #d1d5db',
                                                                            fontSize: '14px',
                                                                            backgroundColor: 'white',
                                                                            textAlign: 'center'
                                                                        }}
                                                                    />
                                                                    <span style={{ fontSize: '14px', color: '#6b7280' }}>ƒë∆°n v·ªã c∆° b·∫£n</span>
                                                                </div>
                                                            </div>

                                                            {/* SKU & Barcode */}
                                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                                                {/* M√£ SKU */}
                                                                <div>
                                                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>
                                                                        M√£ SKU
                                                                    </label>
                                                                    <div style={{ position: 'relative' }}>
                                                                        <input
                                                                            value={variant.sku}
                                                                            onChange={(e) => {
                                                                                const newVariants = [...variants];
                                                                                newVariants[idx].sku = e.target.value;
                                                                                // Auto-sync barcode if empty
                                                                                if (!newVariants[idx].barcode) {
                                                                                    newVariants[idx].barcode = e.target.value;
                                                                                }
                                                                                setVariants(newVariants);
                                                                            }}
                                                                            onBlur={(e) => {
                                                                                // Auto-fill barcode = SKU when barcode is empty
                                                                                const newVariants = [...variants];
                                                                                if (!newVariants[idx].barcode && e.target.value) {
                                                                                    newVariants[idx].barcode = e.target.value;
                                                                                    setVariants(newVariants);
                                                                                }
                                                                            }}
                                                                            placeholder="M√£ SKU phi√™n b·∫£n"
                                                                            style={{
                                                                                width: '100%',
                                                                                padding: '10px 36px 10px 12px',
                                                                                borderRadius: '8px',
                                                                                border: '1px solid #d1d5db',
                                                                                fontSize: '14px',
                                                                                backgroundColor: 'white',
                                                                                boxSizing: 'border-box'
                                                                            }}
                                                                        />
                                                                        <button
                                                                            type="button"
                                                                            onClick={() => openBarcodeScanner((code) => {
                                                                                const newVariants = [...variants];
                                                                                newVariants[idx].sku = code;
                                                                                // Auto-fill barcode if empty
                                                                                if (!newVariants[idx].barcode) {
                                                                                    newVariants[idx].barcode = code;
                                                                                }
                                                                                setVariants(newVariants);
                                                                            })}
                                                                            style={{
                                                                                position: 'absolute',
                                                                                right: '8px',
                                                                                top: '50%',
                                                                                transform: 'translateY(-50%)',
                                                                                background: 'none',
                                                                                border: 'none',
                                                                                cursor: 'pointer',
                                                                                padding: '4px',
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                justifyContent: 'center'
                                                                            }}
                                                                            title="Qu√©t m√£ SKU"
                                                                        >
                                                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                                                                                <path d="M3 5V3h4M17 3h4v2M3 19v2h4M17 21h4v-2" />
                                                                                <path d="M7 7v10M11 7v10M15 7v10M19 7v10" strokeWidth="1.5" />
                                                                            </svg>
                                                                        </button>
                                                                    </div>
                                                                </div>

                                                                {/* M√£ v·∫°ch */}
                                                                <div>
                                                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>
                                                                        M√£ v·∫°ch/ Barcode
                                                                    </label>
                                                                    <div style={{ position: 'relative' }}>
                                                                        <input
                                                                            value={variant.barcode}
                                                                            onChange={(e) => {
                                                                                const newVariants = [...variants];
                                                                                newVariants[idx].barcode = e.target.value;
                                                                                setVariants(newVariants);
                                                                            }}
                                                                            placeholder="Nh·∫≠p ho·∫∑c qu√©t m√£ v·∫°ch"
                                                                            style={{
                                                                                width: '100%',
                                                                                padding: '10px 36px 10px 12px',
                                                                                borderRadius: '8px',
                                                                                border: '1px solid #d1d5db',
                                                                                fontSize: '14px',
                                                                                backgroundColor: 'white',
                                                                                boxSizing: 'border-box'
                                                                            }}
                                                                        />
                                                                        <button
                                                                            type="button"
                                                                            onClick={() => openBarcodeScanner((code) => {
                                                                                const newVariants = [...variants];
                                                                                newVariants[idx].barcode = code;
                                                                                setVariants(newVariants);
                                                                            })}
                                                                            style={{
                                                                                position: 'absolute',
                                                                                right: '8px',
                                                                                top: '50%',
                                                                                transform: 'translateY(-50%)',
                                                                                background: 'none',
                                                                                border: 'none',
                                                                                cursor: 'pointer',
                                                                                padding: '4px',
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                justifyContent: 'center'
                                                                            }}
                                                                            title="Qu√©t m√£ v·∫°ch"
                                                                        >
                                                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                                                                                <path d="M3 5V3h4M17 3h4v2M3 19v2h4M17 21h4v-2" />
                                                                                <path d="M7 7v10M11 7v10M15 7v10M19 7v10" strokeWidth="1.5" />
                                                                            </svg>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* Image upload */}
                                                            <div>
                                                                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>
                                                                    ·∫¢nh phi√™n b·∫£n
                                                                </label>
                                                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                                    {variant.image_url ? (
                                                                        <div style={{ position: 'relative' }}>
                                                                            <img
                                                                                src={variant.image_url}
                                                                                alt={variant.name}
                                                                                onClick={() => setShowImageZoom(variant.image_url)}
                                                                                style={{
                                                                                    width: '80px',
                                                                                    height: '80px',
                                                                                    objectFit: 'cover',
                                                                                    borderRadius: '8px',
                                                                                    border: '1px solid #e5e7eb',
                                                                                    cursor: 'zoom-in'
                                                                                }}
                                                                            />
                                                                            <button
                                                                                type="button"
                                                                                onClick={() => {
                                                                                    const newVariants = [...variants];
                                                                                    newVariants[idx].image_url = '';
                                                                                    setVariants(newVariants);
                                                                                }}
                                                                                style={{
                                                                                    position: 'absolute',
                                                                                    top: '-6px',
                                                                                    right: '-6px',
                                                                                    width: '20px',
                                                                                    height: '20px',
                                                                                    borderRadius: '50%',
                                                                                    background: '#ef4444',
                                                                                    color: 'white',
                                                                                    border: 'none',
                                                                                    cursor: 'pointer',
                                                                                    fontSize: '10px',
                                                                                    display: 'flex',
                                                                                    alignItems: 'center',
                                                                                    justifyContent: 'center'
                                                                                }}
                                                                            >
                                                                                ‚úï
                                                                            </button>
                                                                        </div>
                                                                    ) : (
                                                                        <label style={{
                                                                            width: '80px',
                                                                            height: '80px',
                                                                            border: '2px dashed #d1d5db',
                                                                            borderRadius: '8px',
                                                                            display: 'flex',
                                                                            flexDirection: 'column',
                                                                            alignItems: 'center',
                                                                            justifyContent: 'center',
                                                                            cursor: 'pointer',
                                                                            backgroundColor: '#fafafa'
                                                                        }}>
                                                                            <input
                                                                                type="file"
                                                                                accept="image/*"
                                                                                style={{ display: 'none' }}
                                                                                onChange={(e) => {
                                                                                    const file = e.target.files?.[0];
                                                                                    if (file) {
                                                                                        const reader = new FileReader();
                                                                                        reader.onload = (evt) => {
                                                                                            const newVariants = [...variants];
                                                                                            newVariants[idx].image_url = evt.target?.result as string;
                                                                                            setVariants(newVariants);
                                                                                        };
                                                                                        reader.readAsDataURL(file);
                                                                                    }
                                                                                }}
                                                                            />
                                                                            <span style={{ fontSize: '24px', color: '#9ca3af' }}>üì∑</span>
                                                                            <span style={{ fontSize: '10px', color: '#9ca3af', marginTop: '2px' }}>T·∫£i ·∫£nh</span>
                                                                        </label>
                                                                    )}
                                                                    <p style={{ fontSize: '12px', color: '#9ca3af', margin: 0 }}>
                                                                        Click v√†o ·∫£nh ƒë·ªÉ ph√≥ng to
                                                                    </p>
                                                                </div>
                                                            </div>

                                                            {/* ƒê∆°n v·ªã quy ƒë·ªïi cho phi√™n b·∫£n */}
                                                            <div style={{ marginTop: '16px', padding: '16px', backgroundColor: '#f0f9ff', borderRadius: '10px', border: '1px solid #bae6fd' }}>
                                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: variant.units && variant.units.length > 0 ? '12px' : 0 }}>
                                                                    <span style={{ fontSize: '14px', fontWeight: 600, color: '#0369a1' }}>
                                                                        üì¶ ƒê∆°n v·ªã quy ƒë·ªïi {variant.units && variant.units.length > 0 && `(${variant.units.length})`}
                                                                    </span>
                                                                    <button
                                                                        type="button"
                                                                        onClick={() => {
                                                                            const newVariants = [...variants];
                                                                            if (!newVariants[idx].units) newVariants[idx].units = [];
                                                                            const newUnitSku = generateUniqueSKU();
                                                                            newVariants[idx].units!.push({
                                                                                id: `unit-${Date.now()}`,
                                                                                name: '',
                                                                                sku: newUnitSku,
                                                                                barcode: newUnitSku,
                                                                                conversion_rate: 1,
                                                                                selling_price: 0
                                                                            });
                                                                            setVariants(newVariants);
                                                                        }}
                                                                        style={{
                                                                            fontSize: '13px', color: '#0369a1', fontWeight: 600,
                                                                            background: 'none', border: 'none', cursor: 'pointer'
                                                                        }}
                                                                    >
                                                                        + Th√™m ƒë∆°n v·ªã
                                                                    </button>
                                                                </div>

                                                                {variant.units && variant.units.length > 0 && (
                                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                                                        {variant.units.map((vUnit, uIdx) => (
                                                                            <div key={uIdx} style={{
                                                                                padding: '12px',
                                                                                backgroundColor: 'white',
                                                                                borderRadius: '8px',
                                                                                border: '1px solid #e0f2fe',
                                                                                position: 'relative'
                                                                            }}>
                                                                                <button
                                                                                    type="button"
                                                                                    onClick={() => {
                                                                                        const newVariants = [...variants];
                                                                                        newVariants[idx].units = newVariants[idx].units!.filter((_, i) => i !== uIdx);
                                                                                        setVariants(newVariants);
                                                                                    }}
                                                                                    style={{
                                                                                        position: 'absolute', top: '8px', right: '8px',
                                                                                        color: '#ef4444', background: 'white', border: '1px solid #fecaca',
                                                                                        borderRadius: '4px', width: '22px', height: '22px',
                                                                                        cursor: 'pointer', fontSize: '12px'
                                                                                    }}
                                                                                >‚úï</button>

                                                                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '10px' }}>
                                                                                    <div>
                                                                                        <label style={{ fontSize: '11px', fontWeight: 500, color: '#6b7280' }}>T√™n ƒë∆°n v·ªã</label>
                                                                                        <input
                                                                                            type="text"
                                                                                            placeholder="VD: Th√πng, L·ªëc"
                                                                                            value={vUnit.name}
                                                                                            onChange={(e) => {
                                                                                                const newVariants = [...variants];
                                                                                                newVariants[idx].units![uIdx].name = e.target.value;
                                                                                                setVariants(newVariants);
                                                                                            }}
                                                                                            style={{
                                                                                                width: '100%', padding: '8px', fontSize: '13px',
                                                                                                border: '1px solid #d1d5db', borderRadius: '6px'
                                                                                            }}
                                                                                        />
                                                                                    </div>
                                                                                    <div>
                                                                                        <label style={{ fontSize: '11px', fontWeight: 500, color: '#6b7280' }}>Quy ƒë·ªïi</label>
                                                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                                                            <span style={{ fontSize: '12px' }}>1 {vUnit.name || 'ƒë∆°n v·ªã'} =</span>
                                                                                            <input
                                                                                                type="number"
                                                                                                min="1"
                                                                                                value={vUnit.conversion_rate}
                                                                                                onChange={(e) => {
                                                                                                    const newVariants = [...variants];
                                                                                                    newVariants[idx].units![uIdx].conversion_rate = parseInt(e.target.value) || 1;
                                                                                                    setVariants(newVariants);
                                                                                                }}
                                                                                                style={{
                                                                                                    width: '60px', padding: '8px', fontSize: '13px',
                                                                                                    border: '1px solid #d1d5db', borderRadius: '6px', textAlign: 'center'
                                                                                                }}
                                                                                            />
                                                                                            <span style={{ fontSize: '12px' }}>{variant.name || 'c∆° b·∫£n'}</span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>

                                                                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '10px' }}>
                                                                                    <div>
                                                                                        <label style={{ fontSize: '11px', fontWeight: 500, color: '#6b7280' }}>M√£ SKU</label>
                                                                                        <div style={{ position: 'relative' }}>
                                                                                            <input
                                                                                                type="text"
                                                                                                placeholder="Nh·∫≠p m√£ SKU"
                                                                                                value={vUnit.sku}
                                                                                                onChange={(e) => {
                                                                                                    const newVariants = [...variants];
                                                                                                    newVariants[idx].units![uIdx].sku = e.target.value;
                                                                                                    setVariants(newVariants);
                                                                                                }}
                                                                                                style={{
                                                                                                    width: '100%', padding: '8px 32px 8px 10px', fontSize: '13px',
                                                                                                    border: '1px solid #d1d5db', borderRadius: '6px',
                                                                                                    boxSizing: 'border-box'
                                                                                                }}
                                                                                            />
                                                                                            <button
                                                                                                type="button"
                                                                                                title="Qu√©t m√£ SKU"
                                                                                                onClick={() => openBarcodeScanner((code) => {
                                                                                                    const newVariants = [...variants];
                                                                                                    newVariants[idx].units![uIdx].sku = code;
                                                                                                    setVariants(newVariants);
                                                                                                }, 'm√£ SKU')}
                                                                                                style={{
                                                                                                    position: 'absolute', right: '6px', top: '50%',
                                                                                                    transform: 'translateY(-50%)', background: 'none',
                                                                                                    border: 'none', cursor: 'pointer', padding: '2px',
                                                                                                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                                                                                                }}
                                                                                            >
                                                                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                                                                                                    <path d="M3 5V3h4M17 3h4v2M3 19v2h4M17 21h4v-2" />
                                                                                                    <path d="M7 7v10M11 7v10M15 7v10M19 7v10" strokeWidth="1.5" />
                                                                                                </svg>
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div>
                                                                                        <label style={{ fontSize: '11px', fontWeight: 500, color: '#6b7280' }}>M√£ v·∫°ch/Barcode</label>
                                                                                        <div style={{ position: 'relative' }}>
                                                                                            <input
                                                                                                type="text"
                                                                                                placeholder="Nh·∫≠p m√£ v·∫°ch"
                                                                                                value={vUnit.barcode}
                                                                                                onChange={(e) => {
                                                                                                    const newVariants = [...variants];
                                                                                                    newVariants[idx].units![uIdx].barcode = e.target.value;
                                                                                                    setVariants(newVariants);
                                                                                                }}
                                                                                                style={{
                                                                                                    width: '100%', padding: '8px 32px 8px 10px', fontSize: '13px',
                                                                                                    border: '1px solid #d1d5db', borderRadius: '6px',
                                                                                                    boxSizing: 'border-box'
                                                                                                }}
                                                                                            />
                                                                                            <button
                                                                                                type="button"
                                                                                                title="Qu√©t m√£ v·∫°ch"
                                                                                                onClick={() => openBarcodeScanner((code) => {
                                                                                                    const newVariants = [...variants];
                                                                                                    newVariants[idx].units![uIdx].barcode = code;
                                                                                                    setVariants(newVariants);
                                                                                                }, 'm√£ v·∫°ch')}
                                                                                                style={{
                                                                                                    position: 'absolute', right: '6px', top: '50%',
                                                                                                    transform: 'translateY(-50%)', background: 'none',
                                                                                                    border: 'none', cursor: 'pointer', padding: '2px',
                                                                                                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                                                                                                }}
                                                                                            >
                                                                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                                                                                                    <path d="M3 5V3h4M17 3h4v2M3 19v2h4M17 21h4v-2" />
                                                                                                    <path d="M7 7v10M11 7v10M15 7v10M19 7v10" strokeWidth="1.5" />
                                                                                                </svg>
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>

                                                                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                                                                                    <div>
                                                                                        <label style={{ fontSize: '11px', fontWeight: 500, color: '#6b7280' }}>Gi√° b√°n l·∫ª</label>
                                                                                        <input
                                                                                            type="number"
                                                                                            min="0"
                                                                                            value={vUnit.selling_price}
                                                                                            onChange={(e) => {
                                                                                                const newVariants = [...variants];
                                                                                                newVariants[idx].units![uIdx].selling_price = parseInt(e.target.value) || 0;
                                                                                                setVariants(newVariants);
                                                                                            }}
                                                                                            style={{
                                                                                                width: '100%', padding: '8px', fontSize: '13px',
                                                                                                border: '1px solid #d1d5db', borderRadius: '6px'
                                                                                            }}
                                                                                        />
                                                                                    </div>
                                                                                    <div>
                                                                                        <label style={{ fontSize: '11px', fontWeight: 500, color: '#6b7280' }}>·∫¢nh ƒë∆°n v·ªã</label>
                                                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginTop: '4px' }}>
                                                                                            {vUnit.image_url ? (
                                                                                                <div style={{ position: 'relative' }}>
                                                                                                    <img
                                                                                                        src={vUnit.image_url}
                                                                                                        alt=""
                                                                                                        onClick={() => setShowImageZoom(vUnit.image_url || '')}
                                                                                                        style={{
                                                                                                            width: '60px', height: '60px', objectFit: 'cover',
                                                                                                            borderRadius: '6px', border: '1px solid #e5e7eb', cursor: 'zoom-in'
                                                                                                        }}
                                                                                                    />
                                                                                                    <button
                                                                                                        type="button"
                                                                                                        onClick={() => {
                                                                                                            const newVariants = [...variants];
                                                                                                            newVariants[idx].units![uIdx].image_url = '';
                                                                                                            setVariants(newVariants);
                                                                                                        }}
                                                                                                        style={{
                                                                                                            position: 'absolute', top: '-5px', right: '-5px',
                                                                                                            width: '16px', height: '16px', borderRadius: '50%',
                                                                                                            background: '#ef4444', color: 'white', border: 'none',
                                                                                                            cursor: 'pointer', fontSize: '9px',
                                                                                                            display: 'flex', alignItems: 'center', justifyContent: 'center'
                                                                                                        }}
                                                                                                    >‚úï</button>
                                                                                                </div>
                                                                                            ) : (
                                                                                                <label style={{
                                                                                                    width: '60px', height: '60px', border: '2px dashed #d1d5db',
                                                                                                    borderRadius: '6px', display: 'flex', flexDirection: 'column',
                                                                                                    alignItems: 'center', justifyContent: 'center',
                                                                                                    cursor: 'pointer', backgroundColor: '#fafafa'
                                                                                                }}>
                                                                                                    <input
                                                                                                        type="file"
                                                                                                        accept="image/*"
                                                                                                        style={{ display: 'none' }}
                                                                                                        onChange={(e) => {
                                                                                                            const file = e.target.files?.[0];
                                                                                                            if (file) {
                                                                                                                const reader = new FileReader();
                                                                                                                reader.onload = (evt) => {
                                                                                                                    const newVariants = [...variants];
                                                                                                                    newVariants[idx].units![uIdx].image_url = evt.target?.result as string;
                                                                                                                    setVariants(newVariants);
                                                                                                                };
                                                                                                                reader.readAsDataURL(file);
                                                                                                            }
                                                                                                        }}
                                                                                                    />
                                                                                                    <span style={{ fontSize: '18px', color: '#9ca3af' }}>üì∑</span>
                                                                                                    <span style={{ fontSize: '8px', color: '#9ca3af' }}>T·∫£i ·∫£nh</span>
                                                                                                </label>
                                                                                            )}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : showVariantsSection ? (
                                                <div style={{
                                                    textAlign: 'center',
                                                    padding: '24px',
                                                    color: '#9ca3af',
                                                    border: '2px dashed #e5e7eb',
                                                    borderRadius: '12px',
                                                    backgroundColor: '#fafafa'
                                                }}>
                                                    <div style={{ fontSize: '32px', marginBottom: '8px' }}>üì¶</div>
                                                    <p style={{ margin: 0, fontSize: '14px' }}>Ch∆∞a c√≥ phi√™n b·∫£n n√†o</p>
                                                    <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#b1b1b1' }}>
                                                        Nh·∫•n "+ Th√™m phi√™n b·∫£n" ƒë·ªÉ th√™m phi√™n b·∫£n m·ªõi
                                                    </p>
                                                </div>
                                            ) : null}
                                        </div>

                                        {/* Thu·ªôc t√≠nh s·∫£n ph·∫©m - Collapsible */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '24px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: (showAttributesSection || attributes.length > 0) ? '16px' : 0 }}>
                                                <button
                                                    type="button"
                                                    onClick={() => setShowAttributesSection(!showAttributesSection)}
                                                    style={{
                                                        display: 'flex', alignItems: 'center', gap: '8px',
                                                        fontSize: '16px', fontWeight: 600, color: '#111827',
                                                        background: 'none', border: 'none', cursor: 'pointer',
                                                        padding: 0
                                                    }}
                                                >
                                                    <span style={{
                                                        display: 'inline-block',
                                                        transform: (showAttributesSection || attributes.length > 0) ? 'rotate(90deg)' : 'rotate(0deg)',
                                                        transition: 'transform 0.2s',
                                                        fontSize: '12px'
                                                    }}>‚ñ∂</span>
                                                    Thu·ªôc t√≠nh s·∫£n ph·∫©m
                                                    {attributes.length > 0 && <span style={{ fontSize: '14px', color: '#6b7280', fontWeight: 400 }}>({attributes.length} thu·ªôc t√≠nh)</span>}
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setShowAttributesSection(true);
                                                        setAttributes([...attributes, { name: '', value: '' }]);
                                                    }}
                                                    style={{
                                                        fontSize: '14px', color: '#2563eb', fontWeight: 600,
                                                        background: 'none', border: 'none', cursor: 'pointer',
                                                        display: 'flex', alignItems: 'center', gap: '4px'
                                                    }}
                                                >
                                                    + Th√™m thu·ªôc t√≠nh
                                                </button>
                                            </div>

                                            {(showAttributesSection || attributes.length > 0) && (
                                                <>
                                                    <p style={{ fontSize: '13px', color: '#6b7280', marginBottom: '20px', lineHeight: '1.5' }}>
                                                        Th√™m c√°c thu·ªôc t√≠nh nh∆∞ m√†u s·∫Øc, k√≠ch th∆∞·ªõc, ch·∫•t li·ªáu, v.v. ƒë·ªÉ ph√¢n bi·ªát c√°c bi·∫øn th·ªÉ s·∫£n ph·∫©m.
                                                    </p>

                                                    {attributes.length > 0 ? (
                                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                                            {attributes.map((attr, idx) => (
                                                                <div key={idx} style={{
                                                                    display: 'grid',
                                                                    gridTemplateColumns: '1fr 1fr auto',
                                                                    gap: '12px',
                                                                    alignItems: 'center',
                                                                    padding: '12px 16px',
                                                                    borderRadius: '8px',
                                                                    backgroundColor: '#f8fafc',
                                                                    border: '1px solid #e2e8f0'
                                                                }}>
                                                                    <div>
                                                                        <input
                                                                            placeholder="T√™n thu·ªôc t√≠nh (vd: M√†u s·∫Øc)"
                                                                            value={attr.name}
                                                                            onChange={(e) => {
                                                                                const newAttrs = [...attributes];
                                                                                newAttrs[idx].name = e.target.value;
                                                                                setAttributes(newAttrs);
                                                                            }}
                                                                            style={{
                                                                                width: '100%',
                                                                                padding: '10px 12px',
                                                                                borderRadius: '8px',
                                                                                border: '1px solid #d1d5db',
                                                                                fontSize: '14px',
                                                                                backgroundColor: 'white'
                                                                            }}
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <input
                                                                            placeholder="Gi√° tr·ªã (vd: ƒê·ªè)"
                                                                            value={attr.value}
                                                                            onChange={(e) => {
                                                                                const newAttrs = [...attributes];
                                                                                newAttrs[idx].value = e.target.value;
                                                                                setAttributes(newAttrs);
                                                                            }}
                                                                            style={{
                                                                                width: '100%',
                                                                                padding: '10px 12px',
                                                                                borderRadius: '8px',
                                                                                border: '1px solid #d1d5db',
                                                                                fontSize: '14px',
                                                                                backgroundColor: 'white'
                                                                            }}
                                                                        />
                                                                    </div>
                                                                    <button
                                                                        type="button"
                                                                        onClick={() => {
                                                                            const newAttrs = [...attributes];
                                                                            newAttrs.splice(idx, 1);
                                                                            setAttributes(newAttrs);
                                                                        }}
                                                                        style={{
                                                                            color: '#ef4444',
                                                                            background: 'white',
                                                                            border: '1px solid #fecaca',
                                                                            borderRadius: '6px',
                                                                            width: '32px',
                                                                            height: '32px',
                                                                            cursor: 'pointer',
                                                                            display: 'flex',
                                                                            alignItems: 'center',
                                                                            justifyContent: 'center',
                                                                            fontSize: '14px'
                                                                        }}
                                                                        title="X√≥a thu·ªôc t√≠nh"
                                                                    >
                                                                        ‚úï
                                                                    </button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div style={{
                                                            textAlign: 'center',
                                                            padding: '24px',
                                                            color: '#9ca3af',
                                                            border: '2px dashed #e5e7eb',
                                                            borderRadius: '12px',
                                                            backgroundColor: '#fafafa'
                                                        }}>
                                                            <div style={{ fontSize: '24px', marginBottom: '8px' }}>üè∑Ô∏è</div>
                                                            <p style={{ margin: 0, fontSize: '14px' }}>Ch∆∞a c√≥ thu·ªôc t√≠nh n√†o</p>
                                                            <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#b1b1b1' }}>
                                                                Nh·∫•n "+ Th√™m thu·ªôc t√≠nh" ƒë·ªÉ th√™m thu·ªôc t√≠nh m·ªõi
                                                            </p>
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                        </div>

                                        {/* Th√¥ng tin kho */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '20px' }}>
                                            <h2 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '16px', color: '#111827' }}>Th√¥ng tin kho</h2>

                                            <div style={{ marginBottom: '16px' }}>
                                                <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#2563eb' }}>L∆∞u kho t·∫°i</label>
                                                <select
                                                    name="warehouse"
                                                    style={{
                                                        width: '100%',
                                                        padding: '12px 16px',
                                                        borderRadius: '8px',
                                                        border: '1px solid #e5e7eb',
                                                        fontSize: '14px',
                                                        backgroundColor: 'white',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    <option value="main">C·ª≠a h√†ng ch√≠nh</option>
                                                </select>
                                            </div>

                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginBottom: '16px' }}>
                                                <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                                                    <input type="checkbox" name="track_stock" defaultChecked style={{ width: '18px', height: '18px', accentColor: '#2563eb' }} />
                                                    <span style={{ fontSize: '14px', color: '#374151' }}>Qu·∫£n l√Ω s·ªë l∆∞·ª£ng t·ªìn kho</span>
                                                </label>
                                                <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                                                    <input type="checkbox" name="allow_negative" defaultChecked style={{ width: '18px', height: '18px' }} />
                                                    <span style={{ fontSize: '14px', color: '#374151' }}>Cho ph√©p b√°n √¢m</span>
                                                </label>
                                                <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                                                    <input type="checkbox" name="track_batch" style={{ width: '18px', height: '18px' }} />
                                                    <span style={{ fontSize: '14px', color: '#374151' }}>Qu·∫£n l√Ω s·∫£n ph·∫©m theo l√¥ - HSD</span>
                                                </label>
                                            </div>

                                            <div>
                                                <h3 style={{ fontSize: '14px', fontWeight: 600, marginBottom: '12px', color: '#2563eb' }}>B·∫£ng ph√¢n b·ªë t·ªìn kho</h3>
                                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                                    <thead>
                                                        <tr style={{ backgroundColor: '#dbeafe' }}>
                                                            <th style={{ padding: '10px 12px', textAlign: 'left', fontSize: '13px', fontWeight: 600 }}>Kho l∆∞u tr·ªØ</th>
                                                            <th style={{ padding: '10px 12px', textAlign: 'right', fontSize: '13px', fontWeight: 600 }}>T·ªìn kho</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr style={{ borderBottom: '1px solid #e5e7eb' }}>
                                                            <td style={{ padding: '12px' }}>
                                                                <div style={{ fontWeight: 500 }}>C·ª≠a h√†ng ch√≠nh</div>
                                                                <div style={{ fontSize: '12px', color: '#2563eb' }}>V·ªã tr√≠ l∆∞u kho</div>
                                                            </td>
                                                            <td style={{ padding: '12px', textAlign: 'right' }}>
                                                                <input
                                                                    name="current_stock"
                                                                    type="number"
                                                                    defaultValue={editingProduct?.current_stock || 0}
                                                                    style={{
                                                                        width: '100px',
                                                                        padding: '8px 12px',
                                                                        borderRadius: '6px',
                                                                        border: '1px solid #e5e7eb',
                                                                        fontSize: '14px',
                                                                        textAlign: 'center'
                                                                    }}
                                                                />
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <div style={{ marginTop: '16px' }}>
                                                <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>T·ªìn kho t·ªëi thi·ªÉu</label>
                                                <input
                                                    name="min_stock"
                                                    type="number"
                                                    defaultValue={editingProduct?.min_stock || 5}
                                                    style={{
                                                        width: '120px',
                                                        padding: '10px 12px',
                                                        borderRadius: '8px',
                                                        border: '1px solid #e5e7eb',
                                                        fontSize: '14px'
                                                    }}
                                                />
                                            </div>
                                        </div>

                                        {/* V·∫≠n chuy·ªÉn */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '20px' }}>
                                            <h2 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '16px', color: '#111827' }}>V·∫≠n chuy·ªÉn</h2>

                                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', marginBottom: '16px' }}>
                                                <input type="checkbox" name="requires_shipping" defaultChecked style={{ width: '18px', height: '18px', accentColor: '#2563eb' }} />
                                                <span style={{ fontSize: '14px', color: '#374151' }}>S·∫£n ph·∫©m y√™u c·∫ßu v·∫≠n chuy·ªÉn</span>
                                            </label>

                                            <div>
                                                <label style={{ display: 'block', fontSize: '14px', fontWeight: 500, marginBottom: '6px', color: '#374151' }}>Kh·ªëi l∆∞·ª£ng</label>
                                                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                                    <input
                                                        name="weight"
                                                        type="number"
                                                        defaultValue={0}
                                                        style={{
                                                            width: '150px',
                                                            padding: '10px 12px',
                                                            borderRadius: '8px',
                                                            border: '1px solid #e5e7eb',
                                                            fontSize: '14px'
                                                        }}
                                                    />
                                                    <select style={{
                                                        padding: '10px 12px',
                                                        borderRadius: '8px',
                                                        border: '1px solid #e5e7eb',
                                                        fontSize: '14px',
                                                        backgroundColor: 'white'
                                                    }}>
                                                        <option value="g">g</option>
                                                        <option value="kg">kg</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* ===== RIGHT COLUMN ===== */}
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                        {/* ·∫¢nh s·∫£n ph·∫©m */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '20px' }}>
                                            <h2 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '16px', color: '#111827' }}>·∫¢nh s·∫£n ph·∫©m</h2>
                                            <div
                                                onClick={() => productImage && setShowImageZoom(productImage)}
                                                style={{
                                                    cursor: productImage ? 'zoom-in' : 'default',
                                                    position: 'relative'
                                                }}
                                            >
                                                <ImageUploader
                                                    value={productImage}
                                                    onChange={setProductImage}
                                                    showCamera={true}
                                                />
                                                {productImage && (
                                                    <div style={{
                                                        position: 'absolute',
                                                        bottom: '8px',
                                                        right: '8px',
                                                        background: 'rgba(0,0,0,0.6)',
                                                        color: 'white',
                                                        padding: '4px 8px',
                                                        borderRadius: '4px',
                                                        fontSize: '11px',
                                                        pointerEvents: 'none'
                                                    }}>
                                                        üîç Click ƒë·ªÉ ph√≥ng to
                                                    </div>
                                                )}
                                            </div>
                                        </div>


                                        {/* K√™nh b√°n h√†ng */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '20px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                                <h2 style={{ fontSize: '16px', fontWeight: 600, color: '#111827', margin: 0 }}>K√™nh b√°n h√†ng</h2>
                                                <button type="button" style={{ color: '#2563eb', fontSize: '13px', background: 'none', border: 'none', cursor: 'pointer' }}>
                                                    B·ªè ch·ªçn t·∫•t c·∫£
                                                </button>
                                            </div>

                                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', marginBottom: '8px' }}>
                                                <input type="checkbox" name="channel_pos" defaultChecked style={{ width: '18px', height: '18px', accentColor: '#2563eb' }} />
                                                <span style={{ fontSize: '14px', color: '#374151', fontWeight: 500 }}>POS</span>
                                            </label>
                                            <p style={{ fontSize: '13px', color: '#6b7280', marginLeft: '26px', marginBottom: '12px' }}>√Åp d·ª•ng b·∫£ng gi√° <span style={{ color: '#2563eb' }}>POS</span></p>

                                            <div style={{ borderTop: '1px solid #e5e7eb', margin: '12px 0' }}></div>

                                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                                                <input
                                                    type="checkbox"
                                                    name="exclude_from_loyalty_points"
                                                    defaultChecked={editingProduct?.exclude_from_loyalty_points}
                                                    style={{ width: '18px', height: '18px', accentColor: '#2563eb' }}
                                                />
                                                <span style={{ fontSize: '14px', color: '#374151', fontWeight: 500 }}>Kh√¥ng √°p d·ª•ng t√≠ch ƒëi·ªÉm</span>
                                            </label>
                                            <p style={{ fontSize: '13px', color: '#6b7280', marginLeft: '26px' }}>S·∫£n ph·∫©m n√†y s·∫Ω kh√¥ng ƒë∆∞·ª£c t√≠nh ƒëi·ªÉm khi b√°n</p>
                                        </div>

                                        {/* Danh m·ª•c */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '20px' }}>
                                            <MultiCategorySelect
                                                items={categories}
                                                selectedIds={selectedCategories}
                                                onChange={setSelectedCategories}
                                                onAdd={(name) => addCategory(name)}
                                                onDelete={(id) => deleteItem(id, 'category')}
                                                label="Danh m·ª•c"
                                                placeholder="Ch·ªçn danh m·ª•c"
                                            />

                                            <div style={{ marginTop: '16px' }}>
                                                <SelectWithCRUD
                                                    items={brands}
                                                    value={selectedBrand}
                                                    onChange={setSelectedBrand}
                                                    onAdd={(name) => addBrand(name)}
                                                    onDelete={(id) => deleteItem(id, 'brand')}
                                                    label="Nh√£n hi·ªáu"
                                                    placeholder="Ch·ªçn nh√£n hi·ªáu"
                                                />
                                            </div>

                                            <div style={{ marginTop: '16px' }}>
                                                <SelectWithCRUD
                                                    items={productTypes}
                                                    value={selectedProductType}
                                                    onChange={setSelectedProductType}
                                                    onAdd={(name) => addProductTypeToStore(name)}
                                                    onDelete={(id) => deleteItem(id, 'product_type')}
                                                    label="Lo·∫°i s·∫£n ph·∫©m"
                                                    placeholder="Ch·ªçn lo·∫°i s·∫£n ph·∫©m"
                                                />
                                            </div>
                                        </div>

                                        {/* Tag */}
                                        <div style={{ backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', padding: '20px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                                <h2 style={{ fontSize: '16px', fontWeight: 600, color: '#111827', margin: 0 }}>Tag</h2>
                                                <button type="button" style={{ color: '#2563eb', fontSize: '13px', background: 'none', border: 'none', cursor: 'pointer' }}>
                                                    Danh s√°ch tag
                                                </button>
                                            </div>
                                            <input
                                                name="tags"
                                                placeholder="T√¨m ki·∫øm ho·∫∑c th√™m m·ªõi"
                                                style={{
                                                    width: '100%',
                                                    padding: '10px 12px',
                                                    borderRadius: '8px',
                                                    border: '1px solid #e5e7eb',
                                                    fontSize: '14px',
                                                    boxSizing: 'border-box'
                                                }}
                                            />
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            )}

            {/* Image Zoom Modal */}
            {showImageZoom && (
                <div
                    onClick={() => setShowImageZoom(null)}
                    style={{
                        position: 'fixed',
                        inset: 0,
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        zIndex: 9999,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '24px',
                        cursor: 'zoom-out'
                    }}
                >
                    <button
                        onClick={() => setShowImageZoom(null)}
                        style={{
                            position: 'absolute',
                            top: '20px',
                            right: '20px',
                            background: 'white',
                            border: 'none',
                            borderRadius: '50%',
                            width: '40px',
                            height: '40px',
                            fontSize: '20px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                        }}
                    >
                        ‚úï
                    </button>
                    <img
                        src={showImageZoom || ''}
                        alt="Product zoom"
                        style={{
                            maxWidth: '90vw',
                            maxHeight: '90vh',
                            objectFit: 'contain',
                            borderRadius: '8px'
                        }}
                        onClick={(e) => e.stopPropagation()}
                    />
                </div>
            )}
        </>
    );
}
